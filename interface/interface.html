<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked-katex-extension@5.1.5/lib/index.umd.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" id="highlight-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.2.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" />
<!--     <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script> -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js" integrity="sha512-3EZqKCkk3nMLmbrI7mfry81KH7dkzy/BoDfQrodwLQnS/RbsVlERdYP6J0oiJegRUxSOmx7Y35WNbVKSw7mipw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        mermaid.initialize({  
          startOnLoad: true,  
        }); 
    </script>
    
    <!-- mermaid.initialize({ startOnLoad: true }); -->
    <script src="https://laingsimon.github.io/render-diagram/drawio-renderer.js"></script>
    
    <!-- Reveal.js for slide presentations -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/theme/white.css">
    
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/notes/notes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/highlight/highlight.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/math/math.js"></script>
    
    <!-- BULLETPROOF: CodeMirror 5 -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/indent-fold.min.js"></script>  
      
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.css">  
      
    <script>  
    // CodeMirror 5 - ALWAYS WORKS  
    window.CodeMirror5 = {  
      createEditor: function(parent, doc) {  
        console.log("üöÄ Creating bulletproof CodeMirror 5 editor...");  
      
        try {  
          parent.innerHTML = '';  
      
          const textarea = document.createElement('textarea');  
          textarea.value = doc || `# Python Code Editor (CodeMirror 5)  
    def robust_function():  
        """This ALWAYS works - no module conflicts possible"""  
        import os  
        import sys  
        import json  
        from datetime import datetime  
          
        # Complex Python code with full syntax highlighting  
        data = {  
            'platform': sys.platform,  
            'python_version': sys.version,  
            'current_time': datetime.now().isoformat(),  
            'environment': dict(os.environ)  
        }  
          
        # List comprehension  
        squares = [x**2 for x in range(10) if x % 2 == 0]  
          
        # Dictionary comprehension    
        word_lengths = {word: len(word) for word in ['hello', 'world', 'python']}  
          
        # Exception handling  
        try:  
            result = 10 / 0  
        except ZeroDivisionError as e:  
            print(f"Error: {e}")  
            result = None  
          
        print(json.dumps(data, indent=2))  
        return {'squares': squares, 'words': word_lengths, 'result': result}  
      
    # Start your reliable Python coding here...  
    `;  
          parent.appendChild(textarea);  
      
          const editor = CodeMirror.fromTextArea(textarea, {  
            mode: 'python',  
            theme: 'monokai',  
            lineNumbers: true,  
            indentUnit: 4,  
            lineWrapping: true,  
            autoCloseBrackets: true,  
            matchBrackets: true,  
            styleActiveLine: true,  
            foldGutter: true,  
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],  
            extraKeys: {  
              "Tab": function(cm) {  
                if (cm.somethingSelected()) {  
                  cm.indentSelection("add");  
                } else {  
                  cm.replaceSelection("    ");  
                }  
              },  
              "Shift-Tab": function(cm) {  
                cm.indentSelection("subtract");  
              },  
              "Ctrl-/": function(cm) {  
                cm.toggleComment();  
              },
              "Ctrl-F": "findPersistent", // Enable search  
              "Ctrl-H": "replace"      
            }  
          });  
      
          editor.setSize(null, '70vh');  
          editor.getWrapperElement().style.fontSize = '12px';  
      
          console.log("üéâ CodeMirror 5 editor created successfully!");  
          return editor;  
      
        } catch (error) {  
          console.error("üí• Even CodeMirror 5 failed:", error);  
          throw error;  
        }  
      }  
    };  
      
    console.log("‚úÖ CodeMirror 5 loaded and guaranteed to work");  
    </script>  






    <!-- Include DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css"/>

    <!-- Include DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous"></script>

    <!-- Bootstrap CSS -->
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" integrity="sha512-rt/SrQ4UNIaGfDyEXZtNcyWvQeOq0QLygHluFQcSjaGB04IxWhal71tKuzP6K8eYXYB6vJV4pHkXcmFGGQ1/0w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js" integrity="sha512-igl8WEUuas9k5dtnhKqyyld6TzzRjvMqLC79jkgT3z02FvJyHAuUtyemm/P/jYSne1xwFI06ezQxEwweaiV7VA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="interface/style.css">

    <title>Document Index Interface</title>
</head>
<body>
    
    <div id="loader">
      <h1>
        <div class="d-flex justify-content-center">
          <div class="spinner-border spinner-border-loader text-success" role="status">
            <span class="sr-only">Page will be loaded in 5 seconds on fast wifi connections ... </span>
          </div>
        </div>
      </h1>

    </div>
    <div class="container-fluid">
        <div class="row scrolling-row">
          <ul class="nav nav-tabs" id="pdf-details-tab" role="tablist">
            <li class="nav-item">
                <a class="nav-link" id="show-sidebar" href="#"><i class="fa fa-bars"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" id="hide-navbar" href="#">Show only PDF</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" id="assistant-tab" href="#assistant-view" data-toggle="tab" role="tab">Assistant</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" id="search-tab" href="#search-view" data-toggle="tab" role="tab">Search</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="finchat-tab" href="#finchat-view" data-toggle="tab" role="tab">Prep-Chat</a>
            </li>
            
            
            
            
            <li class="nav-item ml-auto">
                <a class="nav-link" id="logout-link" href="#">
                    <span class="logout-text">Logout</span>
                    <span class="username" id="username" style="display: none;">Logged in as <span id="username">Loading...</span></span>
                </a>
            </li>
          </ul>
          <div id="navbar-trigger" style="height: 5px;"></div>
        </div>
        <div id="chat-pdf-content" style="height: calc(100% - 30px);" class="d-none row scrolling-row">
          <!-- Add a close button to the side of iframe -->
          <iframe id="pdfjs-viewer" src="interface/pdf.js/web/viewer.html" data-original-src="interface/pdf.js/web/viewer.html" width="100%" height="100%" allowfullscreen webkitallowfullscreen></iframe>
          <!-- PDF will be displayed here -->
          <div id="progress" style="display: none;">
              <div id="progressbar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
          </div>
          <span id="progress-status"></span>
        </div>
        <div id="chat-content" class="row scrolling-row" style="height: calc(100% - 30px); max-height: calc(100vh - 30px);">
            

            <div class="col-md-10" id="content-col">
                
                
                <div id="chat-assistant-view" class="container-fluid" style="padding-left: 2px; padding-top: 2px;">
                  <div class="tab-content">
                    <div class="tab-pane fade show active" id="assistant-view" role="tabpanel" style="height: calc(100vh - 55px) !important;">
                      <div class="row scrolling-row">
                        <div class="col-md-2 sidebar sticky-top scrollable-sidebar" id="chat-assistant-sidebar" style="height: calc(100vh - 55px) !important;">
                            <!-- Sidebar -->
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <h5 class="mb-0">Chats</h5>
                                <div class="btn-group">
                                    <button id="add-new-chat" type="button" class="btn btn-primary btn-sm"><i class="fa fa-plus"></i></button>
                                    <button id="add-new-workspace" type="button" class="btn btn-secondary btn-sm" title="New Workspace"><i class="fa fa-folder-plus"></i></button>
                                </div>
                            </div>
                            
                            <!-- Workspace Container -->
                            <div id="workspaces-container" style="margin-top: 10px;">
                                <!-- Workspaces will be dynamically populated here -->
                            </div>
                            
                            <!-- Context Menu for Workspaces -->
                            <div id="workspace-context-menu" class="context-menu" style="display: none;">
                                <ul class="list-unstyled mb-0">
                                    <li><a href="#" id="rename-workspace"><i class="fa fa-edit"></i> Rename</a></li>
                                    <li><a href="#" id="delete-workspace"><i class="fa fa-trash"></i> Delete</a></li>
                                    <li><a href="#" id="change-workspace-color"><i class="fa fa-palette"></i> Change Color</a></li>
                                </ul>
                            </div>
                            
                            <!-- Context Menu for Conversations -->
                            <div id="conversation-context-menu" class="context-menu" style="display: none;">
                                <ul class="list-unstyled mb-0">
                                    <li><a href="#" id="move-to-workspace"><i class="fa fa-folder"></i> Move to Workspace</a></li>
                                    <li class="dropdown-submenu">
                                        <a href="#" class="dropdown-toggle"><i class="fa fa-folder-open"></i> Move to...</a>
                                        <ul id="workspace-submenu" class="dropdown-menu">
                                            <!-- Workspace options will be populated here -->
                                        </ul>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-10" id="chat-assistant" style="height: calc(100vh - 55px) !important;">
                          <div id="mainView" class="container-fluid d-flex flex-column vh-100" style="height: calc(100vh - 55px) !important;">
                              <div class="row d-md-none">
                                  <button id="toggleChatDocsView" class="btn btn-secondary btn-xs rounded-pill d-md-none">
                                    ‚ñº
                                  </button>
                              </div>
                              <div id="chat-doc-view" class="row d-none d-md-flex">
                                  <!-- Chat Docs will be populated here -->
                                  <button id="get-chat-transcript" type="button" class="btn btn-primary mr-2 btn-sm mb-1"><i class="fa fa-download">&nbsp;</i></button>
                                  <button id="share-chat" type="button" class="btn btn-primary mr-2 btn-sm mb-1"><i class="fa fa-share-alt">&nbsp;</i></button>
                                  <button id="add-document-button-chat" type="button" class="btn btn-primary mr-2 btn-sm mb-1"><i class="fa fa-plus">&nbsp; Add Doc</i></button>

                              </div>
                              <div id="chatView" class="row flex-grow-1 overflow-auto">
                                  <!-- Chat messages will be dynamically populated here -->
                              </div>
                              <button id="scrollToBottomBtn" class="btn btn-sm btn-primary" style="opacity: 0.8; display:none; position: fixed; bottom: 80px;left: 50%;transform: translateX(-50%); z-index: 100;">‚ñº</button>
                              <div id="chat-controls">
                                <div class="row mb-1"> <!-- Reduced margin bottom -->
                                    
                                    <div class="input-group" style="width: calc(100% - 90px);">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" id="chat-file-upload-span" style="border-right: none; background-color: transparent;">
                                                <label for="chat-file-upload" class="mb-0" style="cursor: pointer;">
                                                    <i class="fa fa-paperclip"></i> <!-- Paperclip icon -->
                                                </label>
                                                <input id="chat-file-upload" type="file" accept="application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/html, text/markdown, text/md, text/plain, image/jpeg, image/png, image/svg+xml, image/bmp, application/rtf, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, text/csv, text/tab-separated-values, application/parquet, application/x-jsonlines, application/json, application/x-ndjson, audio/mpeg, audio/mp3, audio/wav, audio/x-wav, audio/webm, audio/ogg, audio/flac, audio/x-flac, audio/aac, audio/m4a, audio/x-m4a, audio/mp4, video/mp4" style="display: none;"/>
                                            </span>
                                            <span class="input-group-text" id="voice-record-span" style="border-right: none; background-color: transparent;" title="Voice Input (Ctrl+K)">  
                                                <label for="voice-record" class="mb-0" style="cursor: pointer;">  
                                                    <i class="fa fa-microphone"></i>  
                                                </label>  
                                                <button id="voice-record" style="display: none;"></button>  
                                            </span>  
                                        </div>
                                        <textarea id="messageText" class="dynamic-textarea form-control" placeholder="Type your message here. Press Ctrl+K for voice input." style="max-height: 240px; overflow-y: auto; height: 38px; border-left: none;"></textarea>
                                    </div>
                                    
                                    <div class="input-group-append" style="margin-left: 5px;">
                                        <button id="sendMessageButton" class="btn btn-success">
                                            ‚û§<!-- i class="fas fa-paper-plane"></i--> <!-- You can also add "Send" text here if needed -->
                                        </button>
                                        <button id="stopResponseButton" class="btn btn-danger" style="display: none; margin-left: 5px; position: relative;">
                                            ‚èπ
                                        </button>
                                         <div id="uploadProgressContainer" style="position: relative; display: inline-block; display: none;">
                                              <div id="uploadSpinner" class="spinner-border text-success" role="status">
                                                  <span class="sr-only">Uploading...</span>
                                              </div>
                                              <div id="uploadProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;">
                                                  0%
                                              </div>
                                          </div>
                                    </div>
                                    <div class="input-group-append" style="margin-right: -25px;margin-left: 5px;">
                                      <button id="chatSettingsButton" class="btn btn-secondary rounded-pill" title="Chat Settings">
                                        <i class="fa fa-cogs"></i>
                                      </button>
                                    </div>
                                </div>
                                
                                <!-- Old slide-up controls removed - now using settings modal -->
                              </div>
                          </div>
                        </div>
                      
                      
                      
                      
                      </div>
                    </div>
                  </div>
                </div>

                
                
            </div>
        </div>
        
    </div>

    

    <!-- Add Chat Document Modal -->
    <div class="modal" tabindex="-1" id="add-document-modal-chat">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Document</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="add-document-form">
                      <div class="form-group">
                        <label for="pdf-url">PDF URL (Note: Indexing takes long time (~2 minute).)</label>
                        <input type="text" class="form-control" id="pdf-url" placeholder="Enter PDF URL">
                        <label>Or drop a PDF file here or<button type="button" id="file-upload-button" style="padding-left: 4px; padding-top:2px;" class="btn btn-link">browse</button></label>
                        <div id="drop-area" style="border: 2px dashed #aaa; padding: 10px; text-align: center;">
                          Drop a supported document or audio file here. Common formats (PDF, Word, HTML, Markdown, CSV, audio, etc.) can be uploaded directly.
                        </div>
                        <input type="file" class="form-control-file" id="pdf-file" accept="application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/plain, image/jpeg, image/png, image/svg+xml, image/bmp, application/rtf, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, text/csv, text/tab-separated-values, application/parquet, application/x-jsonlines, application/json, application/x-ndjson, audio/mpeg, audio/mp3, audio/wav, audio/x-wav, audio/webm, audio/ogg, audio/flac, audio/x-flac, audio/aac, audio/m4a, audio/x-m4a, audio/mp4, video/mp4" style="display: none;">  
                      </div>
                      
                        <button id="submit-button" type="submit" class="btn btn-primary">Submit</button>
                        <div id="submit-spinner" style="display: none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Make conversation stateless Modal -->
    <div class="modal fade" id="stateless-conversation-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Conversation Now Stateless</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            The conversation is now stateless. It will be deleted when you refresh the page. In case you want to save the conversation and revisit it later, please click on the "eye" button again.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="$('#stateless-conversation-modal').modal('hide');">Ok</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Make conversation stateful Modal -->
    <div class="modal fade" id="stateful-conversation-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Conversation Stateful</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            The conversation is now Stateful again.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="$('#stateful-conversation-modal').modal('hide');">Ok</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Memory Pad Modal -->
    <div class="modal fade" id="memory-pad-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Memory Pad</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="memory-pad-text" class="form-control" rows="10"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" id="memory-pad-text-save-button" class="btn btn-primary" onclick="$('#memory-pad-modal').modal('hide');">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="user-details-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="user-details-text" class="form-control" rows="10"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" id="user-details-text-save-button" class="btn btn-primary" onclick="$('#user-details-modal').modal('hide');">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Preferences Modal -->
    <div class="modal fade" id="user-preferences-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User Preferences</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="user-preferences-text" class="form-control" rows="10"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" id="user-preferences-text-save-button" class="btn btn-primary" onclick="$('#user-preferences-modal').modal('hide');">Save</button>
          </div>
        </div>
      </div>
    </div>



    <!-- Message Edit Modal -->
    <div class="modal fade" id="message-edit-modal" tabindex="-1" aria-hidden="true">  
      <div class="modal-dialog modal-lg"> <!-- Changed to modal-lg for a larger modal -->  
        <div class="modal-content">  
          <div class="modal-header">  
            <h5 class="modal-title">Edit Message</h5>  
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">  
              <span aria-hidden="true">&times;</span>  
            </button>  
          </div>  
          <div class="modal-body">  
            <textarea id="message-edit-text" class="form-control" rows="15"></textarea> <!-- Increased rows to 15 -->  
          </div>  
          <div class="modal-footer">  
            <button type="button" id="message-edit-text-save-button" class="btn btn-primary" onclick="$('#message-edit-modal').modal('hide');">Save</button>  
          </div>  
        </div>  
      </div>  
    </div>  

    <!-- Copied to clipboard -->
    <div class="modal fade" id="clipboard-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Copied.</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Copied to Clipboard.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="$('#clipboard-modal').modal('hide');">Ok</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Prevent Rendering Modal -->
    <div class="modal fade" id="prevent-chat-rendering" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            You cannot send a message while the previous message is still rendering. Please wait...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Coding Hint Modal -->
    <div id="hint-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1090;">
        <div class="modal-dialog modal-lg" style="max-width: 800px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-lightbulb"></i>&nbsp;üí° Coding Hint
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <div id="hint-status" class="mb-2" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary mr-2" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <small class="text-muted" id="hint-status-text">Generating hint...</small>
                        </div>
                    </div>
                    <div id="hint-content">
                        <!-- Hint content will be populated here -->
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" id="stop-hint-button" class="btn btn-danger" style="display: none;">
                        <i class="bi bi-stop-circle"></i>&nbsp;Stop Hint
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i>&nbsp;Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Doubts Overview Modal -->
    <div id="doubts-overview-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1070;">
        <div class="modal-dialog modal-lg" style="max-width: 900px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-question-circle"></i>&nbsp;üí≠ Message Doubts
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <div id="doubts-overview-loading" class="text-center mb-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading doubts...</p>
                    </div>
                    <div id="doubts-overview-content">
                        <!-- Doubts will be populated here -->
                    </div>
                    <div id="doubts-overview-empty" class="text-center text-muted" style="display: none;">
                        <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">No doubts yet for this message.</p>
                        <button class="btn btn-primary btn-sm" id="ask-first-doubt-btn">
                            <i class="bi bi-plus-circle"></i>&nbsp;Ask First Doubt
                        </button>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" class="btn btn-success" id="ask-new-doubt-from-overview-btn">
                        <i class="bi bi-plus-circle"></i>&nbsp;Ask New Doubt
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i>&nbsp;Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Doubt Chat Modal -->
    <div id="doubt-chat-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1080;">
        <div class="modal-dialog modal-xl" style="max-width: 1200px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-chat-dots"></i>&nbsp;üí¨ Doubt Conversation
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div id="doubt-chat-container" style="height: 80vh; display: flex; flex-direction: column;">
                        <div id="doubt-chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem; background-color: #f8f9fa;">
                            <!-- Doubt conversation messages will appear here -->
                        </div>
                        <div id="doubt-chat-input-area" style="border-top: 1px solid #ddd; padding: 1rem; background-color: white;">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="doubt-voice-record-span" style="border-right: none; background-color: transparent;">  
                                        <label for="doubt-voice-record" class="mb-0" style="cursor: pointer;">  
                                            <i class="fa fa-microphone"></i>  
                                        </label>  
                                        <button id="doubt-voice-record" style="display: none;"></button>  
                                    </span>  
                                </div>
                                <textarea id="doubt-chat-input" class="form-control" placeholder="Ask your doubt or follow-up question..." rows="3" style="resize: none; border-left: none;"></textarea>
                                <div class="input-group-append">
                                    <button id="doubt-chat-send-btn" class="btn btn-primary" type="button" style="height: 100%;">
                                        <i class="bi bi-send"></i>&nbsp;Send
                                    </button>
                                    <button id="stop-doubt-chat-button" class="btn btn-danger" type="button" style="height: 100%; display: none; margin-left: 5px;">
                                        <i class="bi bi-stop-circle"></i>&nbsp;Stop
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted mt-1 d-block">Press Ctrl+Enter to send ‚Ä¢ Press Ctrl+K for voice input</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Management Modal -->
    <div id="prompt-management-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
        <style>
            /* Custom styles for Prompt Manager */
            #prompt-list-items .list-group-item {
                transition: all 0.2s ease;
                border-left: 3px solid transparent;
            }
            #prompt-list-items .list-group-item.active {
                border-left-color: #007bff;
            }
            #prompt-list-items .list-group-item:hover:not(.active) {
                background-color: #f8f9fa;
                border-left-color: #dee2e6;
            }
            .create-new-prompt-container {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 8px;
                margin: 20px;
            }
            .create-new-prompt-container strong {
                color: #ffd700;
            }
            #old-prompts-toggle {
                background-color: #f0f8ff;
                border-radius: 4px;
            }
            .badge-secondary {
                background-color: #6c757d;
            }
            /* Animation for create button */
            #create-new-prompt-btn {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        </style>
        <div class="modal-dialog modal-xl" style="max-width: 1200px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-chat-left-text"></i>&nbsp;üìù Prompt Manager
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div class="row no-gutters" style="height: 70vh;">
                        <!-- Left Panel: Prompt List -->
                        <div class="col-md-4" style="border-right: 1px solid #ddd; background-color: #f8f9fa; overflow-y: auto;">
                            <div class="p-3">
                                <!-- Search Box -->
                                <div class="input-group mb-3">
                                    <input type="text" id="prompt-search-input" class="form-control" placeholder="Search prompts...">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" id="prompt-search-clear">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Prompt List -->
                                <div id="prompt-list-container">
                                    <div id="prompt-list-loading" class="text-center p-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading prompts...</p>
                                    </div>
                                    <div id="prompt-list-items" class="list-group" style="display: none;">
                                        <!-- Prompt items will be populated here -->
                                    </div>
                                    <div id="prompt-list-empty" class="text-center text-muted p-4" style="display: none;">
                                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                        <p class="mt-2">No prompts found</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Panel: Prompt Editor -->
                        <div class="col-md-8" style="display: flex; flex-direction: column;">
                            <!-- Editor Header -->
                            <div id="prompt-editor-header" class="p-3" style="border-bottom: 1px solid #ddd; background-color: white;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 id="prompt-editor-title" class="mb-0">Select a prompt to edit</h6>
                                        <small id="prompt-editor-subtitle" class="text-muted"></small>
                                    </div>
                                    <div id="prompt-editor-actions" style="display: none;">
                                        <button id="prompt-copy-btn" class="btn btn-sm btn-outline-secondary" title="Copy to clipboard">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                        <button id="prompt-revert-btn" class="btn btn-sm btn-outline-warning" title="Revert changes">
                                            <i class="bi bi-arrow-counterclockwise"></i> Revert
                                        </button>
                                        <button id="prompt-save-btn" class="btn btn-sm btn-success" title="Save changes">
                                            <i class="bi bi-check-circle"></i> Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Editor Content -->
                            <div id="prompt-editor-content" class="flex-grow-1 p-3" style="overflow-y: auto; background-color: #f8f9fa;">
                                <div id="prompt-editor-empty" class="text-center text-muted" style="margin-top: 20%;">
                                    <i class="bi bi-file-text" style="font-size: 4rem; opacity: 0.3;"></i>
                                    <p class="mt-3">Select a prompt from the list to view and edit</p>
                                </div>
                                
                                <div id="prompt-editor-form" style="display: none;">
                                    <!-- Prompt Name (Read-only) -->
                                    <div class="form-group">
                                        <label for="prompt-name-input"><strong>Prompt Name</strong></label>
                                        <input type="text" id="prompt-name-input" class="form-control" readonly style="background-color: #e9ecef;">
                                    </div>
                                    
                                    <!-- Prompt Content -->
                                    <div class="form-group">
                                        <label for="prompt-content-textarea"><strong>Content</strong></label>
                                        <textarea id="prompt-content-textarea" class="form-control" rows="12" style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px;"></textarea>
                                        <small class="form-text text-muted">
                                            <span id="prompt-char-count">0</span> characters ‚Ä¢ 
                                            <span id="prompt-line-count">0</span> lines ‚Ä¢ 
                                            <span id="prompt-word-count">0</span> words
                                        </small>
                                    </div>
                                    
                                    <!-- Metadata Section (Collapsible) -->
                                    <div class="card">
                                        <div class="card-header" style="cursor: pointer;" data-toggle="collapse" data-target="#prompt-metadata-collapse">
                                            <i class="bi bi-info-circle"></i> Metadata (Optional)
                                            <i class="bi bi-chevron-down float-right"></i>
                                        </div>
                                        <div id="prompt-metadata-collapse" class="collapse">
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <label for="prompt-description-input">Description</label>
                                                    <input type="text" id="prompt-description-input" class="form-control" placeholder="Brief description of the prompt">
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="prompt-category-input">Category</label>
                                                            <input type="text" id="prompt-category-input" class="form-control" placeholder="e.g., system, user, assistant">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="prompt-tags-input">Tags</label>
                                                            <input type="text" id="prompt-tags-input" class="form-control" placeholder="Comma-separated tags">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">Created: <span id="prompt-created-at">N/A</span></small>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <small class="text-muted">Updated: <span id="prompt-updated-at">N/A</span></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Messages -->
                                    <div id="prompt-editor-messages" class="mt-3">
                                        <!-- Success/Error messages will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <div class="mr-auto">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Changes are saved automatically when you click Save
                        </small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Settings Modal -->
    <div id="chat-settings-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1055;">
        <div class="modal-dialog modal-xl" style="max-width: 1400px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); position: relative; z-index: 1056;">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="fa fa-cogs"></i>&nbsp;‚öôÔ∏è Chat Settings
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto; padding: 1.5rem;">
                    <div id="settings-content">

                        <!-- Model and Agent Selection Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-robot"></i> Model & Agent Selection</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-preamble-selector" class="form-label"><strong>Preamble Options</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-preamble-selector" multiple data-live-search="true">
                                                    <optgroup label="Default Prompts" id="default-prompts-group">
                                                        <option>No Links</option>
                                                        <option selected>Wife Prompt</option>
                                                        <option>Google GL</option>
                                                        <option>Debug LLM</option>
                                                        <option>Short</option>
                                                        <option>Short Coding Interview</option>
                                                        <option>No Code</option>
                                                        <option>ML Design Answer Short</option>
                                                        
                                                        <option>Argumentative</option>
                                                        <option>Blackmail</option>
                                                        <option>More Related Coding Questions</option>
                                                        
                                                        <option>Diagram</option>
                                                        <option>Easy Copy</option>
                                                        <option>Creative</option>
                                                        <option>Explore</option>
                                                        
                                                        <option>Relationship</option>
                                                        <option>Dating Maverick</option>
                                                    </optgroup>
                                                    <optgroup label="Custom Prompts" id="custom-prompts-group">
                                                        <!-- Custom prompts will be dynamically loaded here -->
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-main-model-selector" class="form-label"><strong>Main Model</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-main-model-selector" multiple>
                                                    <optgroup label="Newer Models">
                                                        
                                                        
                                                        <option selected>openai/gpt-5.1</option>
                                                        <option>Sonnet 4.5</option>
                                                        <option>Opus 4.5</option>
                                                        <option>google/gemini-3-pro-preview</option>
                                                        
                                                        
                                                        
                                                        
                                                    </optgroup>
                                                    <optgroup label="Others">
                                                        <option>Filler</option>
                                                        <option>moonshotai/kimi-k2</option>
                                                        <option>mistralai/mistral-large-2512</option>
                                                        
                                                        <option>deepseek-v3.1</option>
                                                        <option>gpt-5.1-codex</option>
                                                        <option>Longcat Flash Chat</option>
                                                        <option>gpt-5-codex</option>
                                                        <option>openai/gpt-5-chat</option>
                                                        <option>qwen/qwen3-max</option>
                                                        <option hidden>x-ai/grok-4</option>
                                                        <option>openai/gpt-5.1-chat</option>
                                                        <option>Qwen3-Coder-Plus</option>
                                                        <option hidden>openai/chatgpt-4o-latest</option> 
                                                        <option hidden>gpt-5</option>
                                                        <option>Sonnet 4</option>
                                                        <option>Gemini-2.5-pro</option>
                                                        <option>Opus 4.1</option>
                                                        <option>google/gemini-2.5-flash</option>
                                                        <option hidden>o4-mini-deep-research</option>
                                                        <option hidden>o3-deep-research</option>
                                                        <option hidden>x-ai/grok-3-beta</option>
                                                        <option>x-ai/grok-3</option>
                                                        <option>sao10k/l3.3-euryale-70b</option>
                                                        <option>thedrummer/anubis-pro-105b-v1</option>
                                                        <option>nousresearch/hermes-3-llama-3.1-405b</option>
                                                        <option>raifle/sorcererlm-8x22b</option>
                                                        <option>perplexity/sonar-pro</option>
                                                        <option hidden>perplexity/sonar-deep-research</option>
                                                    </optgroup>
                                                    
                                                    <optgroup hidden label="Fast Models">
                                                        <option hidden>google/gemini-2.5-flash</option>
                                                        <option hidden>google/gemini-2.5-flash-lite</option>
                                                        <option hidden>google/gemini-2.0-flash-001</option>
                                                        <option hidden>google/gemini-2.0-flash-lite-001</option>
                                                        <option hidden>qwen/qwen-turbo</option>
                                                        <option hidden>openai/gpt-4.1-mini</option>
                                                        <option hidden>x-ai/grok-3-mini</option>
                                                    </optgroup>
                                                    <optgroup hidden label="Reasoning Models">
                                                        <option hidden>Gemini-2.5-pro</option>
                                                        <option hidden>o3-pro</option>
                                                        <option hidden>minimax/minimax-m1</option>
                                                        <option hidden>o1</option>
                                                        <option hidden>o3</option>
                                                        <option hidden>o4-mini-high</option>
                                                        <option hidden>o4-mini-deep-research</option>
                                                        <option hidden>o3-deep-research</option>
                                                        <option hidden>Claude Sonnet 3.7 Thinking</option>
                                                        <option hidden>o1-pro</option>
                                                    </optgroup>
                                                    <optgroup hidden label="Creative Models">
                                                        <option hidden>sao10k/l3.3-euryale-70b</option>
                                                        <option hidden>thedrummer/anubis-pro-105b-v1</option>
                                                        <option hidden>thedrummer/anubis-70b-v1.1</option>
                                                        <option hidden>nousresearch/hermes-3-llama-3.1-405b</option>
                                                        <option hidden>raifle/sorcererlm-8x22b</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-field-selector" class="form-label"><strong>Agent</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-field-selector">
                                                    <option selected>None</option>
                                                    <option hidden>InterviewSimulator</option>
                                                    <option hidden>InterviewSimulatorV2</option>
                                                    <option>NStepCodeAgent</option>
                                                    <option hidden>CodeSolveAgent</option>
                                                    <option>InstructionFollowingAgent</option>
                                                    <option>MLSystemDesignAgent</option>
                                                    <option hidden>NStepAgent</option>
                                                    <option>NResponseAgent</option>
                                                    <option>PerplexitySearch</option>
                                                    <option>JinaSearchAgent</option>
                                                    <option>JinaDeepResearchAgent</option>
                                                    <option>WebSearch</option>
                                                    <option>MultiSourceSearch</option>
                                                    <option hidden>BroadSearch</option>
                                                    <option>WhatIf</option>
                                                    <option hidden>LiteratureReview</option>
                                                    <option hidden>ToCGenerationAgent</option>
                                                    <option hidden>BookCreatorAgent</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Basic Options Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-check-square"></i> Basic Options</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-perform-web-search-checkbox" type="checkbox">
                                            <label class="form-check-label" for="settings-perform-web-search-checkbox">Search</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-search-exact" type="checkbox">
                                            <label class="form-check-label" for="settings-search-exact">Search Exact</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-persist_or_not" type="checkbox" checked>
                                            <label class="form-check-label" for="settings-persist_or_not">Persist</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-ppt-answer" type="checkbox">
                                            <label class="form-check-label" for="settings-ppt-answer">PPT Answer</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-use_memory_pad" type="checkbox">
                                            <label class="form-check-label" for="settings-use_memory_pad">Use Memory Pad</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-render-slides-inline" type="checkbox" checked>
                                            <label class="form-check-label" for="settings-render-slides-inline">Render Slides Inline</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-only-slides" type="checkbox">
                                            <label class="form-check-label" for="settings-only-slides">Only Slides</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-render-close-to-source" type="checkbox">
                                            <label class="form-check-label" for="settings-render-close-to-source">Render Close</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2" style="display:none;">
                                            <input class="form-check-input" id="settings-enable_planner" type="checkbox">
                                            <label class="form-check-label" for="settings-enable_planner">Planner</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-sliders-h"></i> Advanced Settings</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-depthSelector" class="form-label"><strong>Depth Level</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px; display: inline-flex; align-items: center; width: 100%;">
                                                <select id="settings-depthSelector" class="form-control form-control-sm" style="width: 100%; border: none;">
                                                    <option value="1">1</option>
                                                    <option value="2" selected>2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-historySelector" class="form-label"><strong>History</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px; display: inline-flex; align-items: center; width: 100%;">
                                                <select id="settings-historySelector" class="form-control form-control-sm" style="width: 100%; border: none;">
                                                    <option value="-1">‚àÖ</option>
                                                    <option value="0">0</option>
                                                    <option value="1">1</option>
                                                    <option value="2" selected>2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                    <option value="6">6</option>
                                                    <option value="7">7</option>
                                                    <option value="8">8</option>
                                                    <option value="9">9</option>
                                                    <option value="10">10</option>
                                                    <option value="infinite">‚àû</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-rewardLevelSelector" class="form-label"><strong>Reward Level</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px; display: inline-flex; align-items: center; width: 100%;">
                                                <select id="settings-rewardLevelSelector" class="form-control form-control-sm" style="width: 100%; border: none;">
                                                    <option value="-3">-3</option>
                                                    <option value="-2">-2</option>
                                                    <option value="-1">-1</option>
                                                    <option value="0" selected>œÜ</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        

                        <!-- Actions Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-tools"></i> Actions</h6>
                                <div class="row">
                                    <div class="col">
                                        <button id="settings-deleteLastTurn" class="btn btn-danger btn-sm rounded-pill w-100">
                                            <i class="fa fa-trash"></i> Delete Last Turn
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-memory-pad-text-open-button">
                                            <i class="bi bi-pen"></i> Memory Pad
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-user-details-modal-open-button">
                                            <i class="bi bi-pen"></i> User Details
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-user-preferences-modal-open-button">
                                            <i class="bi bi-pen"></i> User Preferences
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-code-editor-modal-open-button">  
                                            <i class="bi bi-code-slash"></i> Code Editor  
                                        </button>  
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-prompt-manager-modal-open-button">
                                            <i class="bi bi-chat-left-text"></i> Prompt Manager
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Permanent Instructions Section -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-sticky-note"></i> Permanent Instructions</h6>
                                <div class="form-group">
                                    <textarea id="settings-permanentText" class="form-control" rows="4" placeholder="Enter permanent instructions that will be included with every message..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Code Theme Section -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-code"></i> Code Theme</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="settings-code-theme-selector" class="form-label"><strong>Highlight.js Theme</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-code-theme-selector">
                                                    <option value="default">Default</option>
                                                    <option value="github">GitHub</option>
                                                    <option value="github-dark">GitHub Dark</option>
                                                    <option value="monokai">Monokai</option>
                                                    <option value="monokai-sublime">Monokai Sublime</option>
                                                    <option value="dracula">Dracula</option>
                                                    <option value="atom-one-dark">Atom One Dark</option>
                                                    <option value="atom-one-light">Atom One Light</option>
                                                    <option value="vs">Visual Studio</option>
                                                    <option value="vs2015">VS 2015 (Dark)</option>
                                                    <option value="nord">Nord</option>
                                                    <option value="tokyo-night-dark">Tokyo Night Dark</option>
                                                    <option value="tokyo-night-light">Tokyo Night Light</option>
                                                    <option value="solarized-dark">Solarized Dark</option>
                                                    <option value="solarized-light">Solarized Light</option>
                                                    <option value="hybrid">Hybrid</option>
                                                    <option value="tomorrow-night">Tomorrow Night</option>
                                                    <option value="tomorrow-night-bright">Tomorrow Night Bright</option>
                                                    <option value="obsidian">Obsidian</option>
                                                    <option value="agate">Agate</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label"><strong>Preview</strong></label>
                                            <div class="code-theme-preview" style="border: 1px solid #ccc; border-radius: 8px; overflow: hidden;">
                                                <pre><code class="hljs javascript">// Code theme preview
function greet(name) {
    const message = `Hello, ${name}!`;
    console.log(message);
    return message;
}

greet("World");</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Links Section -->
                        <div class="row mb-3" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-search"></i> Search & Links</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="settings-linkInput" class="form-label"><strong>Links to Visit</strong></label>
                                            <textarea id="settings-linkInput" class="form-control" rows="3" placeholder="Links to visit, each in a new line"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="settings-searchInput" class="form-label"><strong>Search Phrases</strong></label>
                                            <textarea id="settings-searchInput" class="form-control" rows="3" placeholder="Search phrases, each in a new line"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" id="settings-reset-button" class="btn btn-warning">
                        <i class="fa fa-undo"></i> Reset to Defaults
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fa fa-times"></i> Close
                    </button>
                    <small class="text-muted mr-auto">Settings are automatically applied when you close this dialog</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Z-Index CSS Fix -->
    <style>
        /* Chat Settings Modal - Base level */
        #chat-settings-modal.modal {
            z-index: 1055 !important;
        }
        #chat-settings-modal .modal-backdrop {
            z-index: 1054 !important;
        }
        #chat-settings-modal .modal-dialog {
            z-index: 1056 !important;
            position: relative;
        }
        #chat-settings-modal .modal-content {
            z-index: 1057 !important;
            position: relative;
        }

        /* Secondary Modals - Higher level to appear above chat settings */
        #memory-pad-modal.modal,
        #user-details-modal.modal,
        #user-preferences-modal.modal,
        #code-editor-modal.modal {
            z-index: 1065 !important;
        }
        
        #memory-pad-modal .modal-backdrop,
        #user-details-modal .modal-backdrop,
        #user-preferences-modal .modal-backdrop,
        #code-editor-modal .modal-backdrop {
            z-index: 1064 !important;
        }

        #memory-pad-modal .modal-dialog,
        #user-details-modal .modal-dialog,
        #user-preferences-modal .modal-dialog,
        #code-editor-modal .modal-dialog {
            z-index: 1066 !important;
            position: relative;
        }

        #memory-pad-modal .modal-content,
        #user-details-modal .modal-content,
        #user-preferences-modal .modal-content,
        #code-editor-modal .modal-content {
            z-index: 1067 !important;
            position: relative;
        }
        
        /* Slide Presentation Styles */
        .slide-presentation-wrapper {
            width: 100%;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .slide-presentation-wrapper .reveal {
            width: 100%;
            height: 500px; /* Fixed height for embedded slides */
            background: #ffffff;
        }
        
        .slide-presentation-wrapper .reveal .slides {
            width: 100%;
            height: 100%;
        }
        
        .slide-presentation-wrapper .reveal .slides section {
            height: 100%;
            max-height: 450px;
            overflow: hidden;
            padding: 20px !important;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-size: 0.9em;
        }
        
        /* Slide content styling */
        .slide-presentation-wrapper .reveal h1,
        .slide-presentation-wrapper .reveal h2,
        .slide-presentation-wrapper .reveal h3 {
            margin-top: 0;
            margin-bottom: 0.5em;
            color: #2c3e50;
        }
        
        .slide-presentation-wrapper .reveal h2 {
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .slide-presentation-wrapper .reveal h3 {
            font-size: 1.2em;
            color: #34495e;
        }
        
        .slide-presentation-wrapper .reveal p {
            margin: 0.5em 0;
            line-height: 1.4;
        }
        
        .slide-presentation-wrapper .reveal ul,
        .slide-presentation-wrapper .reveal ol {
            margin: 0.5em 0;
        }
        
        .slide-presentation-wrapper .reveal li {
            margin: 0.2em 0;
            line-height: 1.3;
        }
        
        /* Code block styling for slides */
        .slide-presentation-wrapper .reveal pre {
            width: 100%;
            margin: 10px 0;
            box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.15);
            border-radius: 5px;
            background: #f8f8f8;
            border: 1px solid #e1e1e8;
        }
        
        .slide-presentation-wrapper .reveal pre code {
            max-height: 300px;
            font-size: 0.8em;
            line-height: 1.3;
            padding: 15px;
            overflow-y: auto;
            display: block;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #f8f8f8;
        }
        
        .slide-presentation-wrapper .reveal code {
            font-size: 0.85em;
            padding: 2px 6px;
            background: #f4f4f4;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #c7254e;
            border: 1px solid #e1e1e8;
        }
        
        /* Special coding elements */
        .slide-presentation-wrapper .complexity-analysis {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
        }
        
        .slide-presentation-wrapper .algorithm-step {
            background: #e8f6f3;
            padding: 8px;
            border-left: 4px solid #1abc9c;
            margin: 6px 0;
            font-size: 0.8em;
        }
        
        /* Navigation controls styling */
        .slide-controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .slide-controls .btn {
            font-size: 0.85em;
            padding: 6px 12px;
        }
        
        .slide-counter-display {
            font-weight: 500;
            color: #495057;
        }
        
        /* Responsive design for slides */
        @media (max-width: 768px) {
            .slide-presentation-wrapper .reveal {
                height: 400px;
            }
            
            .slide-presentation-wrapper .reveal .slides section {
                max-height: 350px;
                padding: 15px !important;
                font-size: 0.8em;
            }
            
            .slide-presentation-wrapper .reveal pre code {
                font-size: 0.7em;
                max-height: 200px;
            }
            
            .slide-controls {
                padding: 10px;
            }
            
            .slide-controls .btn {
                font-size: 0.8em;
                padding: 4px 8px;
            }
        }
        
        /* Hide default Reveal.js controls since we have custom ones */
        .slide-presentation-wrapper .reveal .controls {
            display: none;
        }
        
        .slide-presentation-wrapper .reveal .progress {
            height: 3px;
            color: #3498db;
        }
    </style>

    <!-- Full Solution Modal -->
    <div id="solution-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1090;">
        <div class="modal-dialog modal-xl" style="max-width: 900px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-lightbulb-fill"></i>&nbsp;üéØ Complete Solution
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <div id="solution-status" class="mb-2" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary mr-2" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <small class="text-muted" id="solution-status-text">Generating solution...</small>
                        </div>
                    </div>
                    <div id="solution-content">
                        <!-- Solution content will be populated here -->
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" id="stop-solution-button" class="btn btn-danger" style="display: none;">
                        <i class="bi bi-stop-circle"></i>&nbsp;Stop Solution
                    </button>
                    <button type="button" id="copy-solution-btn" class="btn btn-primary" style="margin-right: 8px;">
                        <i class="bi bi-clipboard"></i>&nbsp;Copy to Editor
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i>&nbsp;Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Editor Modal -->  
    <div class="modal fade" id="code-editor-modal" tabindex="-1" aria-hidden="true" style="z-index: 1075;">
      <div class="modal-dialog modal-xl"> <!-- Using modal-xl for more space -->  
        <div class="modal-content">  
          <div class="modal-header">  
            <h5 class="modal-title">  
              <i class="bi bi-code-slash"></i>&nbsp;Python Code Editor  
            </h5>  
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">  
              <span aria-hidden="true">&times;</span>  
            </button>  
          </div>  
          <div class="modal-body p-0"> <!-- Remove padding for full editor space -->  
            <!-- Toolbar for copy/paste actions -->  
            <div class="border-bottom p-2 bg-light">  
              <div class="btn-group" role="group">  
                <button type="button" id="copy-code-button" class="btn btn-sm btn-outline-primary">  
                  <i class="bi bi-clipboard"></i>&nbsp;Copy Code  
                </button> 
              </div>
              <div class="btn-group" role="group">  

                <button type="button" id="hint-code-button" class="btn btn-sm btn-outline-info">  
                  <i class="bi bi-lightbulb-fill"></i></i>&nbsp;Hint  
                </button> 
              </div>
              <div class="btn-group" role="group">  
                <button type="button" id="full-solution-code-button" class="btn btn-sm btn-outline-warning">  
                  <i class="bi bi-magic"></i></i>&nbsp;<b>Full Solution</b>  
                </button> 
              </div>
              <div class="btn-group" role="group">  
                 
                <button type="button" id="clear-code-button" class="btn btn-sm btn-outline-danger">  
                  <i class="bi bi-trash"></i>&nbsp;Clear  
                </button>  
              </div>  
              <div class="btn-group float-right" role="group">  
                <button type="button" id="format-code-button" class="btn btn-sm btn-outline-info">  
                  <i class="bi bi-magic"></i>&nbsp;Format  
                </button>  
              </div>  
            </div>  
            <!-- CodeMirror Editor Container -->  
          <div id="python-code-editor" style="height: calc(80vh - 120px); border: none;"></div>  
          </div>  
          <div class="modal-footer">  
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>  
            <button type="button" id="save-code-button" class="btn btn-primary" hidden>  
              <i class="bi bi-check-lg"></i>&nbsp;Save Code  
            </button>  

            <button type="button" id="run-code-button" class="btn btn-success">  
              <i class="bi bi-play-fill"></i>&nbsp;Run Code  
            </button>  
          </div>  
        </div>  
      </div>  
    </div>  


    <!-- Code Execution Results Modal -->  
    <!-- Code Execution Results Modal - Scrollable Version -->  
    <div class="modal fade" id="code-results-modal" tabindex="-1" aria-hidden="true" style="z-index: 1076;">  
      <div class="modal-dialog modal-lg" style="max-width: 90vw; height: 80vh; margin: 10vh auto;">  
        <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">  
          <div class="modal-header" style="flex-shrink: 0;">  
            <h5 class="modal-title">  
              <i class="bi bi-terminal"></i>&nbsp;Code Execution Results  
            </h5>  
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">  
              <span aria-hidden="true">&times;</span>  
            </button>  
          </div>  
            
          <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1rem;">  
            <!-- Loading state -->  
            <div id="results-loading" class="text-center py-4">  
              <div class="spinner-border text-primary" role="status">  
                <span class="sr-only">Executing code...</span>  
              </div>  
              <p class="mt-2 text-muted">Executing your Python code...</p>  
            </div>  
      
            <!-- Results content (hidden initially) - This div will scroll -->  
            <div id="results-content" class="d-none" style="max-height: none; word-wrap: break-word; white-space: pre-wrap;">  
              <!-- This div will contain the markdown-rendered results -->  
            </div>  
      
            <!-- Error state (hidden initially) -->  
            <div id="results-error" class="d-none">  
              <div class="alert alert-danger">  
                <h6><i class="bi bi-exclamation-triangle"></i> Execution Error</h6>  
                <pre id="error-details" class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;"></pre>  
              </div>  
            </div>  
          </div>  
            
          <div class="modal-footer" style="flex-shrink: 0;">  
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>  
            <button type="button" id="copy-results-button" class="btn btn-outline-primary">  
              <i class="bi bi-clipboard"></i>&nbsp;Copy Results  
            </button>  
          </div>  
        </div>  
      </div>  
    </div>  






    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <script src="interface/parseMessageForCheckBoxes.js"></script>
    <script src="interface/common.js"></script>
    <script src="interface/gamification.js"></script>
    <script src="interface/common-chat.js"></script>
    <script src="interface/interface.js"></script>
    <script src="interface/codemirror.js"></script>
    <script src="interface/doubt-manager.js"></script>
    <script src="interface/prompt-manager.js"></script>
    <script src="interface/chat.js"></script>
    <!-- Add to the <head> section -->
    <link rel="stylesheet" href="interface/workspace-styles.css">

    <!-- Add before closing </body> tag -->
    <script src="interface/workspace-manager.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
    <script>
      function addDarkmodeWidget() {
        new Darkmode({
          bottom: 'unset', // default: '32px'
          right: '32px', // default: '32px'
          left: 'unset', // default: 'unset'
          time: '0.5s', // default: '0.3s'
          mixColor: '#fff', // default: '#fff'
          backgroundColor: '#fff',  // default: '#fff'
          buttonColorDark: '#100f2c',  // default: '#100f2c'
          buttonColorLight: '#fff', // default: '#fff'
          saveInCookies: false, // default: true,
          label: 'üåì', // default: ''
          autoMatchOsTheme: true // default: true
        }).showWidget();
      }
      window.addEventListener('load', addDarkmodeWidget);
    </script>
    <script src="interface/audio_process.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          skipTags: ["code", "pre", "math", "script"],
        },
        
        extensions: ["tex2jax.js", "MathMenu.js", "MathZoom.js", "AssistiveMML.js"],
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "noErrors.js", "noUndefined.js", "color.js", "cases.js"],
          Macros: {
            
            RR: "\\mathbb{R}",
            bold: ["\\mathbf{#1}", 1],
            red: ["\\color{red}{#1}", 1]
          }
        },
        "HTML-CSS": { 
          linebreaks: { automatic: true, width: "container" }
      }
      });
  </script>
  <style>
    .details-close-btn {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 10px;
        display: inline-block;
    }
    .details-close-btn:hover {
        background-color: #e0e0e0;
    }

    /* Custom styling for hint and solution modals */
    #hint-modal, #solution-modal {
        z-index: 1090 !important; /* Above code editor modal */
    }

    /* Code Editor Modal - Mid level */
    #code-editor-modal.modal {
        z-index: 1075 !important;
    }
    #hint-modal .modal-content, #solution-modal .modal-content {
        border: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    #hint-modal .modal-header, #solution-modal .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
    }
    
    #hint-modal .modal-title, #solution-modal .modal-title {
        color: white !important;
        font-weight: 600;
    }
    
    #hint-modal .close, #solution-modal .close {
        color: white !important;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    #hint-modal .close:hover, #solution-modal .close:hover {
        opacity: 1;
        color: white !important;
    }
    
    #hint-content, #solution-content {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
    }
    
    #hint-content pre, #solution-content pre {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
    }
    
    #hint-content code, #solution-content code {
        background-color: #f8f9fa;
        color: #e83e8c;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    #copy-solution-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        transition: all 0.2s;
    }
    
    #copy-solution-btn:hover {
        background: linear-gradient(135deg, #218838 0%, #1da589 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* Doubt Management Styling */
    .show-doubts-button, .ask-doubt-button {
        color: #6c757d;
        transition: color 0.2s;
    }
    
    .show-doubts-button:hover {
        color: #007bff !important;
    }
    
    .ask-doubt-button:hover {
        color: #28a745 !important;
    }
    
    #doubts-overview-modal, #doubt-chat-modal {
        z-index: 1070 !important;
    }
    
    .doubt-preview-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .doubt-preview-card:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        transform: translateY(-1px);
    }
    
    .doubt-preview-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-size: 0.9rem;
        padding: 0.1rem 1rem;
    }
    
    .doubt-preview-card .card-body {
        padding: 1rem;
        font-size: 0.9rem;
    }
    
    .doubt-conversation-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        max-width: 85%;
    }
    
    .doubt-conversation-card.user-doubt {
        margin-left: auto;
        background-color: #e3f2fd;
        border-color: #2196f3;
    }
    
    .doubt-conversation-card.assistant-doubt {
        margin-right: auto;
        background-color: #f1f8e9;
        border-color: #4caf50;
    }
    
    .doubt-conversation-card .card-header {
        font-size: 0.8rem;
        padding: 0.1rem 0.8rem;
        font-weight: 600;
    }
    
    .doubt-conversation-card.user-doubt .card-header {
        background-color: #2196f3;
        color: white;
        border-bottom: 1px solid #1976d2;
    }
    
    .doubt-conversation-card.assistant-doubt .card-header {
        background-color: #4caf50;
        color: white;
        border-bottom: 1px solid #388e3c;
    }
    
    .doubt-conversation-card .card-body {
        padding: 0.8rem;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    #doubt-chat-input {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        transition: border-color 0.2s;
    }
    
    #doubt-chat-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    #doubt-chat-send-btn {
        border-radius: 0 8px 8px 0;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        transition: all 0.2s;
    }
    
    #doubt-chat-send-btn:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .doubt-delete-btn {
        color: #dc3545;
        background: none;
        border: none;
        padding: 2px 4px;
        font-size: 0.8rem;
        opacity: 0.7;
        transition: all 0.2s;
    }
    
    .doubt-delete-btn:hover:not(:disabled) {
        opacity: 1;
        color: #c82333;
        background-color: rgba(220,53,69,0.1);
        border-radius: 3px;
    }
    
    .doubt-delete-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        color: #6c757d !important;
    }
    
    /* Message card header styling */
    .card-header .dropdown-toggle-no-caret::after {
        display: none;
    }
    
    .card-header .dropdown-toggle-no-caret {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 1rem;
        padding: 2px 4px;
    }
    
    .card-header .dropdown-toggle-no-caret:hover {
        color: #495057;
        background-color: rgba(0,0,0,0.05);
        border-radius: 3px;
    }
    
    .card-header .dropdown-toggle-no-caret:focus {
        box-shadow: none;
        outline: none;
    }
    
    /* Copy button in header styling */
    .card-header .copy-btn-header {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 1rem;
        padding: 2px 4px;
        margin-right: 5px;
    }
    
    .card-header .copy-btn-header:hover {
        color: #495057;
        background-color: rgba(0,0,0,0.05);
        border-radius: 3px;
    }
    
    .card-header .copy-btn-header:focus {
        box-shadow: none;
        outline: none;
    }
    
    /* Dropdown menu styling */
    .dropdown-menu {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        font-size: 0.875rem;
        z-index: 1050;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    .dropdown-item.text-danger:hover {
        background-color: #f5c6cb;
        color: #721c24;
    }
    
    /* Audio player container styling */
    .audio-player-container {
        margin-left: 10px;
    }
    
    .audio-player-container .audio-container {
        background: rgba(0,0,0,0.05);
        padding: 5px;
        border-radius: 5px;
        margin: 2px 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-header {
            padding: 0.1rem;
        }
        
        .dropdown-menu {
            font-size: 0.8rem;
        }
        
        .dropdown-item {
            padding: 0.4rem 0.8rem;
        }
        
        .audio-player-container .audio-container audio {
            max-width: 200px;
        }
        
        /* Global inline code styling for proper text wrapping and appearance */
        code.inline-code,
        code:not(.hljs):not([class*="language-"]):not([class*="hljs"]) {
            background-color: #f8f9fa !important;
            color: #e83e8c !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            font-size: 0.9em !important;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            word-wrap: break-word !important;
            white-space: pre-wrap !important;
            display: inline !important;
            border: 1px solid #e1e1e8 !important;
        }
        
        /* Ensure inline code doesn't break layout in paragraphs */
        p code.inline-code,
        p code:not(.hljs):not([class*="language-"]):not([class*="hljs"]) {
            line-height: 1.4 !important;
            vertical-align: baseline !important;
        }
        
        /* Prevent highlight.js from interfering with inline code */
        code.inline-code * {
            color: inherit !important;
            background: transparent !important;
        }
    }
    .h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6 {
        margin-bottom: 0.1rem;
        font-weight: 500;
        line-height: 1.1;
    }
    .h1, h1 {
        font-size: 2rem;
    }
    .h2, h2 {
        font-size: 1.35rem;
    }
    .h3, h3 {
        font-size: 1.2rem;
    }
    .h4, h4 {
        font-size: 1rem;
    }
    .h5, h5 {
        font-size: 0.875rem;
    }
    .h6, h6 {
        font-size: 0.75rem;
    }
    p {
        margin-top: 0;
        margin-bottom: 0.5rem;
    }
    </style>
    <script>
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('details-close-btn')) {
            // Find the parent details element
            let details = event.target.closest('details');
            if (details) {
                // Close the details element
                details.removeAttribute('open');
                // REMOVED: Auto-scroll to summary - was interrupting user reading
                // details.querySelector('summary').scrollIntoView({behavior: 'smooth'});
            }
        }
    });
    </script>
    
    <script>
    // Code Theme Switching Functionality
    $(document).ready(function() {
        // Initialize theme from localStorage
        var savedTheme = localStorage.getItem('highlightTheme') || 'default';
        $('#settings-code-theme-selector').val(savedTheme);
        applyHighlightTheme(savedTheme);
        
        // Handle theme change
        $('#settings-code-theme-selector').on('change', function() {
            var selectedTheme = $(this).val();
            applyHighlightTheme(selectedTheme);
            localStorage.setItem('highlightTheme', selectedTheme);
            
            // Update preview in the settings modal
            updatePreviewHighlight();
            
            // Re-highlight all existing code blocks
            reHighlightAllCode();
        });
        
        // Function to apply highlight.js theme
        function applyHighlightTheme(theme) {
            var themeLink = document.getElementById('highlight-theme');
            if (themeLink) {
                themeLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/' + theme + '.min.css';
            }
        }
        
        // Function to update preview in settings modal
        function updatePreviewHighlight() {
            $('.code-theme-preview pre code').each(function() {
                // Remove existing highlighting classes
                $(this).removeClass();
                $(this).addClass('hljs javascript');
                
                // Re-apply highlighting
                if (typeof hljs !== 'undefined') {
                    hljs.highlightElement(this);
                }
            });
        }
        
        // Function to re-highlight all code blocks in the chat
        function reHighlightAllCode() {
            // Find all code blocks in messages
            $('#messages-container pre code, .message-card pre code').each(function() {
                var element = this;
                var language = $(element).attr('class');
                
                // Skip if it's inline code
                if ($(element).hasClass('inline-code')) {
                    return;
                }
                
                // Extract language from class if present
                if (language) {
                    var langMatch = language.match(/language-(\w+)|hljs\s+(\w+)/);
                    if (langMatch) {
                        var lang = langMatch[1] || langMatch[2];
                        
                        // Re-highlight with the detected language
                        if (typeof hljs !== 'undefined' && hljs.getLanguage(lang)) {
                            // Store the original code
                            var originalCode = element.textContent || element.innerText;
                            
                            // Clear and re-highlight
                            $(element).removeClass();
                            $(element).addClass('hljs ' + lang);
                            element.innerHTML = hljs.highlight(originalCode, { language: lang }).value;
                        }
                    }
                }
            });
        }
        
        // Function to load custom prompts
        function loadCustomPrompts() {
            fetch('/get_prompts', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.prompts) {
                    // data has prompts and prompts_detailed, inside prompts_detailed (which is an array of dicts), there is description, category, and other stuff
                    // zip prompts and prompts_detailed and then filter all the prompts and prompts_detailed that have category as no-empty string.
                    // Combine prompts and prompts_detailed arrays
                    const combinedPrompts = data.prompts.map((promptName, index) => {
                        const detailedInfo = data.prompts_detailed.find(p => p.name === promptName) || {};
                        return {
                            name: promptName,
                            ...detailedInfo
                        };
                    });
                    
                    // Filter prompts that have a non-empty category
                    const categorizedPrompts = combinedPrompts.filter(prompt => 
                        prompt.category.trim() === ''
                    );
                    
                    // Update data.prompts and data.prompts_detailed in place to only include categorized prompts
                    data.prompts = categorizedPrompts.map(prompt => prompt.name);
                    data.prompts_detailed = categorizedPrompts;
                    const customPromptsGroup = $('#custom-prompts-group');
                    const currentSelected = $('#settings-preamble-selector').val() || [];
                    
                    // Clear existing custom prompts
                    customPromptsGroup.empty();
                    
                    // Filter out default prompts that are already in the default group
                    const defaultPrompts = [
                        'No Links', 'Wife Prompt', 'Debug LLM', 'Short', 'Google GL',
                        'Short Coding Interview', 'No Code', 'ML Design Answer Short',
                        'Argumentative', 'Blackmail', 'More Related Coding Questions',
                        'Diagram', 'Easy Copy', 'Creative', 'Explore',
                        'Relationship', 'Dating Maverick'
                    ];
                    
                    // Convert default prompt names to snake_case for comparison
                    const defaultPromptKeys = defaultPrompts.map(p => 
                        p.toLowerCase().replace(/ /g, '_')
                    );
                    
                    // Clear and rebuild the cache
                    window.availableCustomPrompts = [];
                    
                    // Add custom prompts that are not in the default list
                    let customPromptsAdded = 0;
                    data.prompts.forEach(promptName => {
                        // Check if this prompt is not a default one
                        if (!defaultPromptKeys.includes(promptName.toLowerCase())) {
                            // Format the prompt name for display
                            const displayName = promptName
                                .replace(/_/g, ' ')
                                .replace(/\b\w/g, l => l.toUpperCase());
                            
                            // Update cache
                            window.availableCustomPrompts.push({
                                name: promptName,
                                value: `custom:${promptName}`,
                                displayName: displayName
                            });
                            
                            // Create option element
                            const option = $('<option></option>')
                                .val(`custom:${promptName}`)  // Prefix with custom: to identify custom prompts
                                .text(displayName);
                            
                            // Check if this was previously selected
                            if (currentSelected.includes(`custom:${promptName}`)) {
                                option.prop('selected', true);
                            }
                            
                            customPromptsGroup.append(option);
                            customPromptsAdded++;
                        }
                    });
                    
                    // Try to refresh the selectpicker if it exists, otherwise just trigger change
                    try {
                        if ($.fn.selectpicker) {
                            $('#settings-preamble-selector').selectpicker('refresh');
                        }
                    } catch (e) {
                        // Selectpicker not available, trigger change event instead
                        $('#settings-preamble-selector').trigger('change');
                    }
                    
                    // If there are custom prompts, show the optgroup, otherwise hide it
                    if (customPromptsAdded === 0) {
                        customPromptsGroup.append('<option disabled>No custom prompts available</option>');
                    }
                    
                    console.log(`Loaded ${customPromptsAdded} custom prompts`);
                }
            })
            .catch(error => {
                console.error('Error loading custom prompts:', error);
                const customPromptsGroup = $('#custom-prompts-group');
                
                // Fall back to cached prompts if fetch fails
                if (window.availableCustomPrompts && window.availableCustomPrompts.length > 0) {
                    customPromptsGroup.empty();
                    const currentSelected = $('#settings-preamble-selector').val() || [];
                    
                    window.availableCustomPrompts.forEach(prompt => {
                        const option = $('<option></option>')
                            .val(prompt.value)
                            .text(prompt.displayName);
                        if (currentSelected.includes(prompt.value)) {
                            option.prop('selected', true);
                        }
                        customPromptsGroup.append(option);
                    });
                    console.log('Using cached custom prompts due to fetch error');
                } else {
                    customPromptsGroup.empty();
                    customPromptsGroup.append('<option disabled>Error loading prompts</option>');
                }
                
                // Try to refresh the selectpicker if it exists
                try {
                    if ($.fn.selectpicker) {
                        $('#settings-preamble-selector').selectpicker('refresh');
                    }
                } catch (e) {
                    // Selectpicker not available
                    $('#settings-preamble-selector').trigger('change');
                }
            });
        }
        
        // When settings modal opens, update the preview and load custom prompts
        $('#chat-settings-modal').on('shown.bs.modal', function() {
            updatePreviewHighlight();
            loadCustomPrompts();
        });
        
        // Apply saved theme on page load
        if (savedTheme !== 'default') {
            setTimeout(function() {
                reHighlightAllCode();
            }, 500);
        }
    });
    </script>
</body>
</html>
