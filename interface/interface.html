<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <link rel="manifest" href="/interface/manifest.json?v=10">
    <meta name="theme-color" content="#0b0f14">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked-katex-extension@5.1.5/lib/index.umd.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" id="highlight-theme">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.2.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" integrity="sha512-aOG0c6nPNzGk+5zjwyJaoRUgCdOrfSDhmMID2u4+OIslr0GjpLKo7Xm0Ao3xmpM4T8AmIouRkqwj1nrdVsLKEQ==" crossorigin="anonymous" />
<!--     <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script> -->
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.5.0/mermaid.min.js" integrity="sha512-3EZqKCkk3nMLmbrI7mfry81KH7dkzy/BoDfQrodwLQnS/RbsVlERdYP6J0oiJegRUxSOmx7Y35WNbVKSw7mipw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript">
        mermaid.initialize({  
          startOnLoad: true,  
        }); 
    </script>
    
    <!-- mermaid.initialize({ startOnLoad: true }); -->
    <script src="https://laingsimon.github.io/render-diagram/drawio-renderer.js"></script>
    
    <!-- Reveal.js for slide presentations -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/theme/white.css">
    
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/notes/notes.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/markdown/markdown.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/highlight/highlight.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/plugin/math/math.js"></script>
    
    <!-- BULLETPROOF: CodeMirror 5 -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/closebrackets.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/selection/active-line.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/indent-fold.min.js"></script>  
      
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">  
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.css">
    
    <!-- CodeMirror Markdown/GFM mode for message editing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gfm/gfm.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/overlay.min.js"></script>
    
    <!-- EasyMDE - Markdown Editor (Option 2) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>  
      
    <script>  
    // CodeMirror 5 - ALWAYS WORKS  
    window.CodeMirror5 = {  
      createEditor: function(parent, doc) {  
        console.log("üöÄ Creating bulletproof CodeMirror 5 editor...");  
      
        try {  
          parent.innerHTML = '';  
      
          const textarea = document.createElement('textarea');  
          textarea.value = doc || `# Python Code Editor (CodeMirror 5)  
    def robust_function():  
        """This ALWAYS works - no module conflicts possible"""  
        import os  
        import sys  
        import json  
        from datetime import datetime  
          
        # Complex Python code with full syntax highlighting  
        data = {  
            'platform': sys.platform,  
            'python_version': sys.version,  
            'current_time': datetime.now().isoformat(),  
            'environment': dict(os.environ)  
        }  
          
        # List comprehension  
        squares = [x**2 for x in range(10) if x % 2 == 0]  
          
        # Dictionary comprehension    
        word_lengths = {word: len(word) for word in ['hello', 'world', 'python']}  
          
        # Exception handling  
        try:  
            result = 10 / 0  
        except ZeroDivisionError as e:  
            print(f"Error: {e}")  
            result = None  
          
        print(json.dumps(data, indent=2))  
        return {'squares': squares, 'words': word_lengths, 'result': result}  
      
    # Start your reliable Python coding here...  
    `;  
          parent.appendChild(textarea);  
      
          const editor = CodeMirror.fromTextArea(textarea, {  
            mode: 'python',  
            theme: 'monokai',  
            lineNumbers: true,  
            indentUnit: 4,  
            lineWrapping: true,  
            autoCloseBrackets: true,  
            matchBrackets: true,  
            styleActiveLine: true,  
            foldGutter: true,  
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],  
            extraKeys: {  
              "Tab": function(cm) {  
                if (cm.somethingSelected()) {  
                  cm.indentSelection("add");  
                } else {  
                  cm.replaceSelection("    ");  
                }  
              },  
              "Shift-Tab": function(cm) {  
                cm.indentSelection("subtract");  
              },  
              "Ctrl-/": function(cm) {  
                cm.toggleComment();  
              },
              "Ctrl-F": "findPersistent", // Enable search  
              "Ctrl-H": "replace"      
            }  
          });  
      
          editor.setSize(null, '70vh');  
          editor.getWrapperElement().style.fontSize = '12px';  
      
          console.log("üéâ CodeMirror 5 editor created successfully!");  
          return editor;  
      
        } catch (error) {  
          console.error("üí• Even CodeMirror 5 failed:", error);  
          throw error;  
        }  
      }  
    };  
      
    console.log("‚úÖ CodeMirror 5 loaded and guaranteed to work");  
    </script>  






    <!-- Include DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css"/>

    <!-- Include DataTables JS -->
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous"></script>

    <!-- Bootstrap CSS -->
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" integrity="sha512-rt/SrQ4UNIaGfDyEXZtNcyWvQeOq0QLygHluFQcSjaGB04IxWhal71tKuzP6K8eYXYB6vJV4pHkXcmFGGQ1/0w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js" integrity="sha512-igl8WEUuas9k5dtnhKqyyld6TzzRjvMqLC79jkgT3z02FvJyHAuUtyemm/P/jYSne1xwFI06ezQxEwweaiV7VA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="interface/style.css">

    <title>Document Index Interface</title>
</head>
<body>
    
    <div id="loader">
      <h1>
        <div class="d-flex justify-content-center">
          <div class="spinner-border spinner-border-loader text-success" role="status">
            <span class="sr-only">Page will be loaded in 5 seconds on fast wifi connections ... </span>
          </div>
        </div>
      </h1>

    </div>
    <div class="container-fluid">
        <div class="row scrolling-row">
          <ul class="nav nav-tabs" id="pdf-details-tab" role="tablist">
            <li class="nav-item">
                <a class="nav-link" id="show-sidebar" href="#"><i class="fa fa-bars"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" id="hide-navbar" href="#">Show only PDF</a>
            </li>
            
            <li class="nav-item">
                <a class="nav-link" id="assistant-tab" href="#assistant-view" data-toggle="tab" role="tab">Assistant</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" id="search-tab" href="#search-view" data-toggle="tab" role="tab">Search</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="finchat-tab" href="#finchat-view" data-toggle="tab" role="tab">Prep-Chat</a>
            </li>
            
            
            
            
            <li class="nav-item ml-auto">
                <a class="nav-link" id="logout-link" href="#">
                    <span class="logout-text">Logout</span>
                    <span class="username" id="username" style="display: none;">Logged in as <span id="username">Loading...</span></span>
                </a>
            </li>
          </ul>
          <div id="navbar-trigger" style="height: 5px;"></div>
        </div>
        <div id="chat-pdf-content" style="height: calc(100% - 30px);" class="d-none row scrolling-row">
          <!-- Add a close button to the side of iframe -->
          <iframe id="pdfjs-viewer" src="interface/pdf.js/web/viewer.html" data-original-src="interface/pdf.js/web/viewer.html" width="100%" height="100%" allowfullscreen webkitallowfullscreen></iframe>
          <!-- PDF will be displayed here -->
          <div id="progress" style="display: none;">
              <div id="progressbar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
          </div>
          <span id="progress-status"></span>
        </div>
        <div id="chat-content" class="row scrolling-row" style="height: calc(100% - 30px); max-height: calc(100vh - 30px);">
            

            <div class="col-md-10" id="content-col">
                
                
                <div id="chat-assistant-view" class="container-fluid" style="padding-left: 2px; padding-top: 2px;">
                  <div class="tab-content">
                    <div class="tab-pane fade show active" id="assistant-view" role="tabpanel" style="height: calc(100vh - 55px) !important;">
                      <div class="row scrolling-row">
                        <div class="col-md-2 sidebar sticky-top scrollable-sidebar" id="chat-assistant-sidebar" style="height: calc(100vh - 55px) !important;">
                            <!-- Sidebar -->
                            <div class="sidebar-toolbar d-flex justify-content-between align-items-center mt-2">
                                <h5 class="mb-0">Explorer</h5>
                                <div class="sidebar-toolbar-actions">
                                    <button id="add-new-chat" type="button" class="btn btn-sm sidebar-tool-btn" title="New Conversation"><i class="fa fa-file-o"></i></button>
                                    <button id="add-new-workspace" type="button" class="btn btn-sm sidebar-tool-btn" title="New Workspace"><i class="fa fa-folder-o"></i></button>
                                </div>
                            </div>
                            
                            <!-- jsTree Container -->
                            <div id="workspaces-container" style="margin-top: 4px;">
                                <!-- jsTree will be initialised here -->
                            </div>
                        </div>
                        <div class="col-md-10" id="chat-assistant" style="height: calc(100vh - 55px) !important;">
                          <div id="mainView" class="container-fluid d-flex flex-column vh-100" style="height: calc(100vh - 55px) !important;">
                              <div class="row d-flex align-items-center flex-nowrap">
                                  <!-- Col 1: Mobile-only toggle for chat-doc-view -->
                                  <div class="d-md-none mr-2">
                                      <button id="toggleChatDocsView" class="btn btn-secondary btn-xs rounded-pill">
                                        ‚ñº
                                      </button>
                                  </div>
                                  <!-- Col 2: Chat doc action buttons ‚Äî hidden on mobile, toggled by Col 1 -->
                                  <div id="chat-doc-view" class="d-none d-md-flex align-items-center flex-wrap">
                                      <button id="get-chat-transcript" type="button" class="btn btn-primary mr-2 btn-sm mb-1"><i class="fa fa-download">&nbsp;</i></button>
                                      <button id="share-chat" type="button" class="btn btn-primary mr-2 btn-sm mb-1"><i class="fa fa-share-alt">&nbsp;</i></button>
                                      <button id="add-document-button-chat" type="button" class="btn btn-primary mr-2 btn-sm mb-1"><i class="fa fa-plus">&nbsp; Add Doc</i></button>
                                      <button id="global-docs-button" type="button" class="btn btn-outline-info mr-2 btn-sm mb-1"><i class="fa fa-globe">&nbsp; Global Docs</i></button>
                                      <button id="ext-extract-page" class="btn btn-outline-info mr-2 btn-sm mb-1 ext-btn" style="display:none;" title="Extract content from current page"><i class="fa fa-globe"></i> Page</button>
                                      <button id="ext-refresh-page" class="btn btn-outline-info mr-2 btn-sm mb-1 ext-btn" style="display:none;" title="Refresh page context"><i class="fa fa-refresh"></i> Refresh</button>
                                      <button id="ext-multi-tab" class="btn btn-outline-info mr-2 btn-sm mb-1 ext-btn" style="display:none;" title="Capture content from multiple tabs"><i class="fa fa-clone"></i> Multi-tab</button>
                                  </div>
                                  <!-- Col 3: New Temp Chat ‚Äî always visible, pushed to far right -->
                                  <div class="ml-auto">
                                      <button id="new-temp-chat" type="button" class="btn btn-outline-secondary btn-sm mb-1" title="New Temporary Chat (deleted on page reload)"><i class="fa fa-eye-slash">&nbsp;</i></button>
                                  </div>
                              </div>
                              <div id="chatView" class="row flex-grow-1 overflow-auto">
                                  <!-- Chat messages will be dynamically populated here -->
                              </div>
                              <button id="scrollToBottomBtn" class="btn btn-sm btn-primary" style="opacity: 0.8; display:none; position: fixed; bottom: 80px;left: 50%;transform: translateX(-50%); z-index: 100;">‚ñº</button>
                              <!-- Page Context Panel (hidden until content extracted) -->
                                  <div id="page-context-panel" style="display: none;">
                                   <div class="page-context-header d-flex justify-content-between align-items-center">
                                       <span>
                                           <i class="fa fa-globe"></i> <strong>Page Context</strong>
                                           <span id="page-context-count" class="badge badge-info ml-1" style="display:none;">1</span>
                                       </span>
                                       <div>
                                           <button id="page-context-view" class="btn btn-sm btn-link p-0 mr-1" title="View full content"><i class="fa fa-eye"></i></button>
                                           <button id="page-context-refresh" class="btn btn-sm btn-link p-0 mr-1" title="Refresh"><i class="fa fa-refresh"></i></button>
                                           <button id="page-context-toggle" class="btn btn-sm btn-link p-0 mr-1" title="Expand/Collapse"><i class="fa fa-chevron-down"></i></button>
                                           <button id="page-context-clear" class="btn btn-sm btn-link p-0 text-danger" title="Clear"><i class="fa fa-times"></i></button>
                                       </div>
                                   </div>
                                   <div id="page-context-body" style="display: none; max-height: 150px; overflow-y: auto;"></div>
                               </div>

                              <div id="chat-controls">
                                <div id="attachment-preview" class="attachment-preview" style="display: none;"></div>
                                <div class="row mb-1"> <!-- Reduced margin bottom -->
                                    
                                    <div class="input-group" style="width: calc(100% - 90px);">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text" id="chat-file-upload-span" style="border-right: none; background-color: transparent;">
                                                <label for="chat-file-upload" class="mb-0" style="cursor: pointer;">
                                                    <i class="fa fa-paperclip"></i> <!-- Paperclip icon -->
                                                </label>
                                                <input id="chat-file-upload" type="file" accept="application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/html, text/markdown, text/md, text/plain, image/jpeg, image/png, image/svg+xml, image/bmp, application/rtf, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, text/csv, text/tab-separated-values, application/parquet, application/x-jsonlines, application/json, application/x-ndjson, audio/mpeg, audio/mp3, audio/wav, audio/x-wav, audio/webm, audio/ogg, audio/flac, audio/x-flac, audio/aac, audio/m4a, audio/x-m4a, audio/mp4, video/mp4" style="display: none;"/>
                                            </span>
                                            <span class="input-group-text" id="voice-record-span" style="border-right: none; background-color: transparent;" title="Voice Input (Ctrl+K)">  
                                                <label for="voice-record" class="mb-0" style="cursor: pointer;">  
                                                    <i class="fa fa-microphone"></i>  
                                                </label>  
                                                <button id="voice-record" style="display: none;"></button>  
                                            </span>  
                                        </div>
                                        <textarea id="messageText" class="dynamic-textarea form-control" placeholder="Type your message here. Press Ctrl+K for voice input." style="max-height: 240px; overflow-y: auto; height: 38px; border-left: none;"></textarea>
                                    </div>
                                    
                                    <div class="input-group-append" style="margin-left: 5px;">
                                        <button id="sendMessageButton" class="btn btn-success">
                                            ‚û§<!-- i class="fas fa-paper-plane"></i--> <!-- You can also add "Send" text here if needed -->
                                        </button>
                                        <button id="stopResponseButton" class="btn btn-danger" style="display: none; margin-left: 5px; position: relative;">
                                            ‚èπ
                                        </button>
                                         <div id="uploadProgressContainer" style="position: relative; display: inline-block; display: none;">
                                              <div id="uploadSpinner" class="spinner-border text-success" role="status">
                                                  <span class="sr-only">Uploading...</span>
                                              </div>
                                              <div id="uploadProgressText" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold;">
                                                  0%
                                              </div>
                                          </div>
                                    </div>
                                    <div class="input-group-append" style="margin-right: -25px;margin-left: 5px;">
                                      <button id="chatSettingsButton" class="btn btn-secondary rounded-pill" title="Chat Settings">
                                        <i class="fa fa-cogs"></i>
                                      </button>
                                    </div>
                                </div>
                                
                                <!-- Old slide-up controls removed - now using settings modal -->
                              </div>
                          </div>
                        </div>
                      
                      
                      
                      
                      </div>
                    </div>
                  </div>
                </div>

                
                
            </div>
        </div>
        
    </div>

    

    <!-- Add Chat Document Modal -->
    <div class="modal" tabindex="-1" id="add-document-modal-chat">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Document</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="add-document-form">
                      <div class="form-group">
                        <label for="pdf-url">PDF URL (Note: Indexing takes long time (~2 minute).)</label>
                        <input type="text" class="form-control" id="pdf-url" placeholder="Enter PDF URL">
                        <label>Or drop a PDF file here or<button type="button" id="file-upload-button" style="padding-left: 4px; padding-top:2px;" class="btn btn-link">browse</button></label>
                        <div id="drop-area" style="border: 2px dashed #aaa; padding: 10px; text-align: center;">
                          Drop a supported document or audio file here. Common formats (PDF, Word, HTML, Markdown, CSV, audio, etc.) can be uploaded directly.
                        </div>
                        <input type="file" class="form-control-file" id="pdf-file" accept="application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/plain, image/jpeg, image/png, image/svg+xml, image/bmp, application/rtf, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, text/csv, text/tab-separated-values, application/parquet, application/x-jsonlines, application/json, application/x-ndjson, audio/mpeg, audio/mp3, audio/wav, audio/x-wav, audio/webm, audio/ogg, audio/flac, audio/x-flac, audio/aac, audio/m4a, audio/x-m4a, audio/mp4, video/mp4" style="display: none;">  
                      </div>
                      
                        <button id="submit-button" type="submit" class="btn btn-primary">Submit</button>
                        <div id="submit-spinner" style="display: none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Global Documents Management Modal -->
    <div class="modal fade" id="global-docs-modal" tabindex="-1" role="dialog" aria-labelledby="globalDocsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="globalDocsModalLabel">Global Documents</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="card mb-3">
              <div class="card-header"><h6 class="mb-0">Add New Global Document</h6></div>
              <div class="card-body">
                <form id="global-doc-upload-form">
                  <div class="form-group">
                    <label for="global-doc-url">Document URL</label>
                    <input type="text" class="form-control" id="global-doc-url" placeholder="Enter URL (PDF, web page, YouTube, etc.)">
                  </div>
                  <div class="form-group">
                    <label>Or drop a file here or <button type="button" id="global-doc-browse-btn" class="btn btn-link" style="padding-left: 4px; padding-top: 2px;">browse</button></label>
                    <div id="global-doc-drop-area" style="border: 2px dashed #aaa; padding: 10px; text-align: center; cursor: pointer;">
                      Drop a supported document or audio file here. Common formats (PDF, Word, HTML, Markdown, CSV, audio, etc.) can be uploaded directly.
                    </div>
                    <input type="file" class="form-control-file" id="global-doc-file-input"
                           accept="application/pdf, application/msword, application/vnd.openxmlformats-officedocument.wordprocessingml.document, text/html, text/markdown, text/plain, image/jpeg, image/png, image/svg+xml, image/bmp, application/rtf, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, text/csv, text/tab-separated-values, application/parquet, application/x-jsonlines, application/json, application/x-ndjson, audio/mpeg, audio/mp3, audio/wav, audio/x-wav, audio/webm, audio/ogg, audio/flac, audio/x-flac, audio/aac, audio/m4a, audio/x-m4a, audio/mp4, video/mp4"
                           style="display: none;">
                  </div>
                  <div class="form-group">
                    <label for="global-doc-display-name">Display Name (optional)</label>
                    <input type="text" class="form-control" id="global-doc-display-name" placeholder="Custom name for this document">
                  </div>
                  <button type="submit" class="btn btn-primary" id="global-doc-submit-btn">Upload</button>
                  <span id="global-doc-upload-spinner" style="display:none;">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span id="global-doc-upload-progress">0%</span>
                  </span>
                </form>
              </div>
            </div>
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Your Global Documents</h6>
                <button class="btn btn-sm btn-outline-secondary" id="global-doc-refresh-btn" title="Refresh list">
                  <i class="fa fa-refresh"></i>
                </button>
              </div>
              <div class="card-body p-0">
                <div id="global-docs-list" class="list-group list-group-flush"></div>
                <div id="global-docs-empty" class="p-3 text-center text-muted" style="display:none;">
                  No global documents yet. Upload one above.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Make conversation stateless Modal -->
    <div class="modal fade" id="stateless-conversation-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Conversation Now Stateless</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            The conversation is now stateless. It will be deleted when you refresh the page. In case you want to save the conversation and revisit it later, please click on the "eye" button again.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="$('#stateless-conversation-modal').modal('hide');">Ok</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Make conversation stateful Modal -->
    <div class="modal fade" id="stateful-conversation-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Conversation Stateful</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            The conversation is now Stateful again.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="$('#stateful-conversation-modal').modal('hide');">Ok</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Memory Pad Modal -->
    <div class="modal fade" id="memory-pad-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Memory Pad</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="memory-pad-text" class="form-control" rows="10"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" id="memory-pad-text-save-button" class="btn btn-primary" onclick="$('#memory-pad-modal').modal('hide');">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="user-details-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="user-details-text" class="form-control" rows="10"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" id="user-details-text-save-button" class="btn btn-primary" onclick="$('#user-details-modal').modal('hide');">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- User Preferences Modal -->
    <div class="modal fade" id="user-preferences-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">User Preferences</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <textarea id="user-preferences-text" class="form-control" rows="10"></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" id="user-preferences-text-save-button" class="btn btn-primary" onclick="$('#user-preferences-modal').modal('hide');">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Clear Locks Modal -->
    <div class="modal fade" id="clear-locks-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fa fa-lock"></i> Lock File Status</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div id="lock-status-content">
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2">Checking lock status...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-warning" id="lock-clear-button" style="display:none;">
              <i class="fa fa-eraser"></i> Clear Stuck Locks
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Personal Knowledge Base (PKB) Modal -->
    <div class="modal fade" id="pkb-modal" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-brain"></i> Personal Knowledge Base</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" id="pkb-tabs" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="pkb-claims-tab" data-toggle="tab" href="#pkb-claims-pane" role="tab">
                  <i class="bi bi-card-text"></i> Claims
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="pkb-entities-tab" data-toggle="tab" href="#pkb-entities-pane" role="tab">
                  <i class="bi bi-people"></i> Entities
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="pkb-tags-tab" data-toggle="tab" href="#pkb-tags-pane" role="tab">
                  <i class="bi bi-tags"></i> Tags
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="pkb-conflicts-tab" data-toggle="tab" href="#pkb-conflicts-pane" role="tab">
                  <i class="bi bi-exclamation-triangle"></i> Conflicts
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="pkb-bulk-tab" data-toggle="tab" href="#pkb-bulk-pane" role="tab">
                  <i class="bi bi-plus-square"></i> Bulk Add
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="pkb-import-tab" data-toggle="tab" href="#pkb-import-pane" role="tab">
                  <i class="bi bi-file-text"></i> Import Text
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="pkb-contexts-tab" data-toggle="tab" href="#pkb-contexts-pane" role="tab">
                  <i class="bi bi-folder"></i> Contexts
                </a>
              </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content mt-3" id="pkb-tabs-content">
              
              <!-- Claims Tab -->
              <div class="tab-pane fade show active" id="pkb-claims-pane" role="tabpanel">
                <!-- Search and Add -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="input-group">
                      <input type="text" id="pkb-search-input" class="form-control" placeholder="Search your memories...">
                      <div class="input-group-append">
                        <button class="btn btn-outline-primary" id="pkb-search-btn" type="button">
                          <i class="bi bi-search"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6 text-right">
                    <button class="btn btn-success" id="pkb-add-claim-btn">
                      <i class="bi bi-plus-lg"></i> Add Memory
                    </button>
                  </div>
                </div>
                
                <!-- Filters Row 1: Type, Domain, Status -->
                <div class="row mb-2">
                  <div class="col-md-4">
                    <select id="pkb-filter-type" class="form-control form-control-sm" multiple title="Filter by type (multi-select)">
                      <option value="">All Types</option>
                      <option value="fact">Facts</option>
                      <option value="preference">Preferences</option>
                      <option value="decision">Decisions</option>
                      <option value="task">Tasks</option>
                      <option value="reminder">Reminders</option>
                      <option value="habit">Habits</option>
                      <option value="memory">Memories</option>
                      <option value="observation">Observations</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select id="pkb-filter-domain" class="form-control form-control-sm" multiple title="Filter by domain (multi-select)">
                      <option value="">All Domains</option>
                      <option value="personal">Personal</option>
                      <option value="health">Health</option>
                      <option value="work">Work</option>
                      <option value="relationships">Relationships</option>
                      <option value="learning">Learning</option>
                      <option value="life_ops">Life Ops</option>
                      <option value="finance">Finance</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select id="pkb-filter-status" class="form-control form-control-sm">
                      <option value="active">Active</option>
                      <option value="">All Statuses</option>
                      <option value="contested">Contested</option>
                      <option value="historical">Historical</option>
                    </select>
                  </div>
                </div>
                <!-- Filters Row 2: Entity, Tag, Sort -->
                <div class="row mb-3">
                  <div class="col-md-4">
                    <select id="pkb-filter-entity" class="form-control form-control-sm">
                      <option value="">All Entities</option>
                      <!-- Populated dynamically by JS -->
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select id="pkb-filter-tag" class="form-control form-control-sm">
                      <option value="">All Tags</option>
                      <!-- Populated dynamically by JS -->
                    </select>
                  </div>
                  <div class="col-md-4">
                    <select id="pkb-sort-by" class="form-control form-control-sm">
                      <option value="-updated_at">Recently Updated</option>
                      <option value="-created_at">Recently Created</option>
                      <option value="statement">Alphabetical</option>
                      <option value="claim_type">By Type</option>
                      <option value="context_domain">By Domain</option>
                    </select>
                  </div>
                </div>
                
                <!-- Claims List -->
                <div id="pkb-claims-list" class="list-group">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p>No memories yet. Add your first one!</p>
                  </div>
                </div>
                
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                  <span id="pkb-claims-count" class="text-muted">0 claims</span>
                  <div>
                    <button class="btn btn-sm btn-outline-secondary" id="pkb-prev-page" disabled>
                      <i class="bi bi-chevron-left"></i> Prev
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="pkb-next-page">
                      Next <i class="bi bi-chevron-right"></i>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Entities Tab -->
              <div class="tab-pane fade" id="pkb-entities-pane" role="tabpanel">
                <!-- Add Entity Form -->
                <div class="row mb-3">
                  <div class="col-md-5">
                    <input type="text" id="pkb-new-entity-name" class="form-control form-control-sm" placeholder="Entity name (e.g., Mom, Python, Gym)">
                  </div>
                  <div class="col-md-4">
                    <select id="pkb-new-entity-type" class="form-control form-control-sm">
                      <option value="person">Person</option>
                      <option value="org">Organization</option>
                      <option value="place">Place</option>
                      <option value="topic" selected>Topic</option>
                      <option value="project">Project</option>
                      <option value="system">System</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <button class="btn btn-success btn-sm btn-block" id="pkb-add-entity-btn">
                      <i class="bi bi-plus-lg"></i> Add Entity
                    </button>
                  </div>
                </div>
                
                <div id="pkb-entities-list" class="list-group">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-person-badge" style="font-size: 2rem;"></i>
                    <p>Entities (people, places, topics) linked to your memories will appear here.</p>
                  </div>
                </div>
              </div>
              
              <!-- Tags Tab -->
              <div class="tab-pane fade" id="pkb-tags-pane" role="tabpanel">
                <div id="pkb-tags-list" class="list-group">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-tag" style="font-size: 2rem;"></i>
                    <p>Tags used to organize your memories will appear here.</p>
                  </div>
                </div>
              </div>
              
              <!-- Conflicts Tab -->
              <div class="tab-pane fade" id="pkb-conflicts-pane" role="tabpanel">
                <div id="pkb-conflicts-list" class="list-group">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i>
                    <p>Conflicting memories that need resolution will appear here.</p>
                  </div>
                </div>
              </div>
              
              <!-- Bulk Add Tab -->
              <div class="tab-pane fade" id="pkb-bulk-pane" role="tabpanel">
                <div class="mb-3">
                  <small class="text-muted">
                    Add multiple memories at once. Each row becomes one memory item.
                    Fill in the details and click "Save All" when ready.
                  </small>
                </div>
                
                <!-- Bulk Rows Container -->
                <div id="pkb-bulk-rows-container" style="max-height: 350px; overflow-y: auto;">
                  <!-- Rows will be rendered here by JS -->
                </div>
                
                <!-- Bulk Actions -->
                <div class="mt-3 d-flex justify-content-between align-items-center">
                  <button class="btn btn-outline-primary" id="pkb-bulk-add-row">
                    <i class="bi bi-plus"></i> Add Another Row
                  </button>
                  <div>
                    <button class="btn btn-outline-secondary mr-2" id="pkb-bulk-clear-all">
                      <i class="bi bi-x-lg"></i> Clear All
                    </button>
                    <button class="btn btn-success" id="pkb-bulk-save-all">
                      <i class="bi bi-check-all"></i> Save All Memories
                    </button>
                  </div>
                </div>
                
                <!-- Progress Indicator -->
                <div id="pkb-bulk-progress" class="mt-3" style="display:none;">
                  <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%" id="pkb-bulk-progress-bar"></div>
                  </div>
                  <small class="text-muted"><span id="pkb-bulk-progress-text">Saving...</span></small>
                </div>
                
                <!-- Results Summary -->
                <div id="pkb-bulk-results" class="mt-3" style="display:none;">
                  <div class="alert alert-success" id="pkb-bulk-success-alert">
                    <i class="bi bi-check-circle"></i> <span id="pkb-bulk-success-count">0</span> memories saved successfully!
                  </div>
                  <div class="alert alert-danger" id="pkb-bulk-error-alert" style="display:none;">
                    <i class="bi bi-exclamation-triangle"></i> <span id="pkb-bulk-error-count">0</span> failed to save.
                  </div>
                </div>
              </div>
              
              <!-- Import Text Tab -->
              <div class="tab-pane fade" id="pkb-import-pane" role="tabpanel">
                <div class="mb-3">
                  <small class="text-muted">
                    Paste a large block of text below. AI will extract memories, compare with existing ones, 
                    and let you review each proposed change before saving.
                  </small>
                </div>
                
                <!-- Text Input -->
                <div class="form-group">
                  <textarea id="pkb-import-text" class="form-control" rows="8" 
                            placeholder="Paste your text here...&#10;&#10;Examples:&#10;- I prefer working in the morning&#10;- My favorite color is blue&#10;- I'm allergic to peanuts&#10;- I work at Acme Corp as a software engineer"></textarea>
                </div>
                
                <!-- Default Type/Domain -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="pkb-import-default-type" class="small">Default Type</label>
                    <select id="pkb-import-default-type" class="form-control form-control-sm">
                      <option value="fact" selected>Fact</option>
                      <option value="preference">Preference</option>
                      <option value="decision">Decision</option>
                      <option value="task">Task</option>
                      <option value="reminder">Reminder</option>
                      <option value="habit">Habit</option>
                      <option value="memory">Memory</option>
                      <option value="observation">Observation</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label for="pkb-import-default-domain" class="small">Default Domain</label>
                    <select id="pkb-import-default-domain" class="form-control form-control-sm">
                      <option value="personal" selected>Personal</option>
                      <option value="health">Health</option>
                      <option value="work">Work</option>
                      <option value="relationships">Relationships</option>
                      <option value="learning">Learning</option>
                      <option value="life_ops">Life Ops</option>
                      <option value="finance">Finance</option>
                    </select>
                  </div>
                </div>
                
                <!-- Use LLM Option -->
                <div class="form-check mb-3">
                  <input type="checkbox" class="form-check-input" id="pkb-import-use-llm" checked>
                  <label class="form-check-label" for="pkb-import-use-llm">
                    <i class="bi bi-magic"></i> Use AI for intelligent parsing (recommended)
                    <br><small class="text-muted">AI will split compound sentences, infer types, and clean up formatting</small>
                  </label>
                </div>
                
                <!-- Analyze Button -->
                <button class="btn btn-primary" id="pkb-import-analyze">
                  <i class="bi bi-search"></i> Analyze &amp; Extract Memories
                </button>
                
                <!-- Loading Indicator -->
                <div id="pkb-import-loading" class="mt-3" style="display:none;">
                  <div class="d-flex align-items-center">
                    <div class="spinner-border text-primary mr-2" role="status"></div>
                    <span>Analyzing text and comparing with existing memories...</span>
                  </div>
                </div>
                
                <!-- Error Display -->
                <div id="pkb-import-error" class="alert alert-danger mt-3" style="display:none;"></div>
              </div>
              
              <!-- Contexts Tab (v0.5) -->
              <div class="tab-pane fade" id="pkb-contexts-pane" role="tabpanel">
                <div class="mb-3">
                  <small class="text-muted">
                    Contexts let you group memories into collections. Reference a context with <code>@context_friendly_id</code> in chat 
                    to include all its memories in the conversation.
                  </small>
                </div>
                
                <!-- Create Context Form -->
                <div class="card mb-3">
                  <div class="card-body py-2">
                    <div class="row">
                      <div class="col-md-4">
                        <input type="text" id="pkb-new-context-name" class="form-control form-control-sm" placeholder="Context name">
                      </div>
                      <div class="col-md-3">
                        <input type="text" id="pkb-new-context-friendly-id" class="form-control form-control-sm" placeholder="@friendly_id (optional)">
                      </div>
                      <div class="col-md-3">
                        <input type="text" id="pkb-new-context-description" class="form-control form-control-sm" placeholder="Description (optional)">
                      </div>
                      <div class="col-md-2">
                        <button class="btn btn-success btn-sm btn-block" id="pkb-create-context-btn">
                          <i class="bi bi-plus-lg"></i> Create
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Contexts List -->
                <div id="pkb-contexts-list" class="list-group">
                  <div class="text-center text-muted py-4">
                    <i class="bi bi-folder" style="font-size: 2rem;"></i>
                    <p>No contexts yet. Create one to group your memories!</p>
                  </div>
                </div>
              </div>
              
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PKB Claim Add/Edit Modal -->
    <div class="modal fade" id="pkb-claim-edit-modal" tabindex="-1" aria-hidden="true" style="z-index: 1070;">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="pkb-claim-edit-title">Add Memory</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="pkb-claim-edit-id">
            
            <div class="form-group">
              <label for="pkb-claim-statement">What do you want to remember?</label>
              <textarea id="pkb-claim-statement" class="form-control" rows="3" placeholder="e.g., I prefer morning workouts..."></textarea>
              <button type="button" id="pkb-autofill-btn" class="btn btn-link btn-sm p-0 mt-1" style="font-size: 0.78rem; color: #6c757d;" title="Auto-fill fields using AI">
                <i class="bi bi-magic"></i> Auto-fill
              </button>
            </div>
            
            <div class="form-group">
              <label for="pkb-claim-friendly-id">Friendly ID <small class="text-muted">(optional, auto-generated if blank)</small></label>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">@</span>
                </div>
                <input type="text" id="pkb-claim-friendly-id" class="form-control" placeholder="e.g., morning_workouts" pattern="[a-zA-Z0-9_-]+">
              </div>
              <small class="form-text text-muted">Use this ID to reference this memory in chat with @friendly_id</small>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="pkb-claim-type">Type <small class="text-muted">(Ctrl/Cmd for multi)</small></label>
                  <select id="pkb-claim-type" class="form-control" multiple size="4">
                    <!-- Populated dynamically from /pkb/types -->
                  </select>
                  <div class="input-group input-group-sm mt-1">
                    <input type="text" id="pkb-new-type-input" class="form-control" placeholder="New type...">
                    <div class="input-group-append">
                      <button class="btn btn-outline-success" id="pkb-add-new-type" type="button" title="Add custom type"><i class="bi bi-plus"></i></button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="pkb-claim-domain">Domain <small class="text-muted">(Ctrl/Cmd for multi)</small></label>
                  <select id="pkb-claim-domain" class="form-control" multiple size="4">
                    <!-- Populated dynamically from /pkb/domains -->
                  </select>
                  <div class="input-group input-group-sm mt-1">
                    <input type="text" id="pkb-new-domain-input" class="form-control" placeholder="New domain...">
                    <div class="input-group-append">
                      <button class="btn btn-outline-success" id="pkb-add-new-domain" type="button" title="Add custom domain"><i class="bi bi-plus"></i></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="pkb-claim-tags">Tags (comma separated)</label>
              <input type="text" id="pkb-claim-tags" class="form-control" placeholder="e.g., fitness, routine, morning">
            </div>
            
            <div class="form-group">
              <label for="pkb-claim-questions">Possible Questions <small class="text-muted">(auto-generated if left blank; one per line)</small></label>
              <textarea id="pkb-claim-questions" class="form-control" rows="3" placeholder="What questions does this memory answer?&#10;e.g., What are my dietary restrictions?&#10;Am I allergic to anything?"></textarea>
              <small class="form-text text-muted">Questions this memory answers. Used to improve search relevance.</small>
            </div>
            
            <div class="form-group">
              <label for="pkb-claim-contexts">Contexts <small class="text-muted">(optional, hold Ctrl/Cmd to multi-select)</small></label>
              <select id="pkb-claim-contexts" class="form-control" multiple size="4">
                <!-- Populated dynamically from /pkb/contexts -->
              </select>
              <small class="form-text text-muted">Assign this memory to one or more contexts/groups</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="pkb-claim-save-btn">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Memory Update Proposal Modal (Enhanced for Bulk Operations) -->
    <div class="modal fade" id="memory-proposal-modal" tabindex="-1" aria-hidden="true" data-backdrop="static" style="z-index: 1075;">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title"><i class="bi bi-lightbulb"></i> Review Memory Updates</h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="memory-proposal-intro" class="text-muted mb-3">
              Review and approve the proposed memory changes below:
            </p>
            
            <!-- Summary Counts -->
            <div class="mb-3 d-flex flex-wrap" style="gap: 8px;">
              <span class="badge badge-success" id="proposal-add-count">
                <i class="bi bi-plus-circle"></i> 0 new
              </span>
              <span class="badge badge-warning" id="proposal-edit-count">
                <i class="bi bi-pencil"></i> 0 updates
              </span>
              <span class="badge badge-secondary" id="proposal-skip-count">
                <i class="bi bi-dash-circle"></i> 0 skipped
              </span>
            </div>
            
            <!-- Select Controls -->
            <div class="mb-2 d-flex justify-content-between align-items-center">
              <div>
                <button class="btn btn-sm btn-outline-secondary mr-1" id="proposal-select-all">
                  <i class="bi bi-check-all"></i> Select All
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="proposal-deselect-all">
                  <i class="bi bi-x"></i> Deselect All
                </button>
              </div>
              <small class="text-muted">
                <span id="proposal-selected-count">0</span> selected
              </small>
            </div>
            
            <!-- Proposals List (scrollable) -->
            <div id="memory-proposal-list" style="max-height: 400px; overflow-y: auto;">
              <!-- Proposals will be rendered here as editable rows -->
            </div>
            
            <!-- Hidden Fields -->
            <input type="hidden" id="memory-proposal-plan-id">
            <input type="hidden" id="memory-proposal-source" value="conversation">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" id="memory-proposal-skip" data-dismiss="modal">
              <i class="bi bi-x-lg"></i> Cancel
            </button>
            <button type="button" class="btn btn-primary" id="memory-proposal-save">
              <i class="bi bi-check-lg"></i> Save Selected (<span id="proposal-save-count">0</span>)
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Message Edit Modal -->
    <div class="modal fade" id="message-edit-modal" tabindex="-1" aria-hidden="true">  
      <div class="modal-dialog modal-xl"> <!-- Changed to modal-xl for larger editing space -->  
        <div class="modal-content">  
          <div class="modal-header d-flex justify-content-between align-items-center">  
            <h5 class="modal-title">Edit Message</h5>
            <div class="d-flex align-items-center">
              <!-- Editor Type Selector -->
              <select id="message-edit-editor-type" class="form-control form-control-sm mr-3" style="width: auto;">
                <option value="codemirror-preview" selected>CodeMirror + Preview</option>
                <option value="easymde">EasyMDE (with toolbar)</option>
                <option value="milkdown">WYSIWYG Editor</option>
              </select>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">  
                <span aria-hidden="true">&times;</span>  
              </button>
            </div>
          </div>  
          <div class="modal-body p-0" style="height: 65vh;">
            <!-- Tab Navigation (shown for tabbed editors) -->
            <ul class="nav nav-tabs px-3 pt-2" id="message-edit-tabs" role="tablist" style="display: none;">
              <li class="nav-item">
                <a class="nav-link active" id="edit-code-tab" data-toggle="tab" href="#edit-code-pane" role="tab">
                  <i class="bi bi-code-slash mr-1"></i>Code
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="edit-preview-tab" data-toggle="tab" href="#edit-preview-pane" role="tab">
                  <i class="bi bi-eye mr-1"></i>Preview
                </a>
              </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content h-100" id="message-edit-tab-content">
              <!-- Code Editor Pane -->
              <div class="tab-pane fade show active h-100" id="edit-code-pane" role="tabpanel">
                <!-- CodeMirror container -->
                <div id="message-edit-codemirror-container" class="h-100" style="display: none;"></div>
                <!-- EasyMDE container (Option 2) -->
                <div id="message-edit-easymde-container" class="h-100" style="display: none;">
                  <textarea id="message-edit-text-easymde"></textarea>
                </div>
                <!-- Milkdown/WYSIWYG container (Option 5) - uses ContentEditable fallback -->
                <div id="message-edit-milkdown-container" class="h-100" style="display: none; overflow-y: auto;"></div>
                <!-- Fallback textarea (hidden, used for data) -->
                <textarea id="message-edit-text" class="form-control h-100" style="display: none;" rows="15"></textarea>
              </div>
              <!-- Preview Pane -->
              <div class="tab-pane fade h-100" id="edit-preview-pane" role="tabpanel">
                <div id="message-edit-preview" class="h-100 p-3" style="overflow-y: auto;"></div>
              </div>
            </div>
          </div>  
          <div class="modal-footer">
            <span id="message-edit-scroll-info" class="text-muted small mr-auto" style="display: none;">
              Scroll position synced between tabs
            </span>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" id="message-edit-text-save-button" class="btn btn-primary">Save</button>  
          </div>  
        </div>  
      </div>  
    </div>  

    <!-- Artefacts Modal -->
    <div class="modal fade" id="artefacts-modal" tabindex="-1" aria-hidden="true">
      <style>
        .artefact-diff-view {
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          font-size: 12px;
          line-height: 1.4;
        }
        .artefact-diff-line {
          white-space: pre;
        }
        .artefact-diff-header {
          color: #6c757d;
        }
        .artefact-diff-hunk {
          background: rgba(13, 110, 253, 0.08);
          color: #0d6efd;
          font-weight: 600;
        }
        .artefact-diff-add {
          background: rgba(25, 135, 84, 0.12);
          color: #198754;
        }
        .artefact-diff-del {
          background: rgba(220, 53, 69, 0.12);
          color: #dc3545;
        }
        .artefact-diff-toggle {
          cursor: pointer;
          margin-right: 8px;
        }
      </style>
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header d-flex justify-content-between align-items-center">
            <h5 class="modal-title">Artefacts</h5>
            <div class="d-flex align-items-center">
              <select id="artefact-file-type" class="form-control form-control-sm mr-2" style="width: auto;">
                <option value="md">Markdown (.md)</option>
                <option value="txt">Text (.txt)</option>
                <option value="py">Python (.py)</option>
                <option value="js">JavaScript (.js)</option>
                <option value="json">JSON (.json)</option>
                <option value="html">HTML (.html)</option>
                <option value="css">CSS (.css)</option>
              </select>
              <button type="button" id="artefact-copy-btn" class="btn btn-sm btn-outline-secondary mr-2">Copy</button>
              <button type="button" id="artefact-download-btn" class="btn btn-sm btn-outline-secondary mr-2">Download</button>
              <button type="button" id="artefact-delete-btn" class="btn btn-sm btn-outline-danger mr-2">Delete</button>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
          <div class="modal-body">
            <div class="d-flex h-100">
              <div class="border-right" style="width: 280px; overflow-y: auto;">
                <div class="p-2">
                  <button id="artefact-create-btn" class="btn btn-sm btn-primary btn-block">New Artefact</button>
                  <div id="artefacts-list" class="list-group mt-2"></div>
                </div>
              </div>
              <div class="flex-grow-1 d-flex flex-column">
                <ul class="nav nav-tabs px-3 pt-2" id="artefacts-tabs" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="artefact-code-tab" data-toggle="tab" href="#artefact-code-pane" role="tab">Code</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="artefact-preview-tab" data-toggle="tab" href="#artefact-preview-pane" role="tab">Preview</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="artefact-diff-tab" data-toggle="tab" href="#artefact-diff-pane" role="tab">Diff</a>
                  </li>
                </ul>
                <div class="tab-content flex-grow-1" id="artefacts-tab-content" style="height: 100%; overflow: hidden;">
                  <div class="tab-pane fade show active h-100" id="artefact-code-pane" role="tabpanel">
                    <textarea id="artefact-editor-textarea" class="form-control h-100" rows="10" style="border: none; border-radius: 0; resize: none;"></textarea>
                  </div>
                  <div class="tab-pane fade h-100" id="artefact-preview-pane" role="tabpanel">
                    <div id="artefact-preview" class="h-100 p-3" style="overflow-y: auto;"></div>
                  </div>
                  <div class="tab-pane fade h-100" id="artefact-diff-pane" role="tabpanel" style="height: 100%; overflow: auto;">
                    <div id="artefact-diff" class="artefact-diff-view p-3" style="margin: 0; height: 100%; overflow: auto;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer d-flex align-items-start">
            <div class="flex-grow-1 mr-2">
              <textarea id="artefact-instruction" class="form-control" rows="2" placeholder="Describe the changes you want the AI to make..."></textarea>
              <div class="d-flex align-items-center mt-2">
                <div class="form-check mr-3">
                  <input class="form-check-input" type="checkbox" id="artefact-include-summary">
                  <label class="form-check-label" for="artefact-include-summary">Include summary</label>
                </div>
                <div class="form-check mr-3">
                  <input class="form-check-input" type="checkbox" id="artefact-include-messages">
                  <label class="form-check-label" for="artefact-include-messages">Include recent messages</label>
                </div>
                <div class="form-check mr-3">
                  <input class="form-check-input" type="checkbox" id="artefact-include-memory">
                  <label class="form-check-label" for="artefact-include-memory">Include memory pad</label>
                </div>
                <div class="form-inline">
                  <label class="mr-1 text-muted small" for="artefact-history-count">History</label>
                  <input id="artefact-history-count" type="number" class="form-control form-control-sm" style="width: 70px;" value="10" min="0" max="50">
                </div>
              </div>
            </div>
            <div class="d-flex">
              <button type="button" id="artefact-save-btn" class="btn btn-outline-primary mr-2">Save</button>
              <button type="button" id="artefact-propose-btn" class="btn btn-primary mr-2">Propose edits</button>
              <button type="button" id="artefact-apply-btn" class="btn btn-success mr-2" disabled>Apply</button>
              <button type="button" id="artefact-discard-btn" class="btn btn-outline-secondary">Discard</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Copied to clipboard -->
    <div class="modal fade" id="clipboard-modal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Copied.</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Copied to Clipboard.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="$('#clipboard-modal').modal('hide');">Ok</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Prevent Rendering Modal -->
    <div class="modal fade" id="prevent-chat-rendering" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-body">
            You cannot send a message while the previous message is still rendering. Please wait...
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Coding Hint Modal -->
    <div id="hint-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1090;">
        <div class="modal-dialog modal-lg" style="max-width: 800px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-lightbulb"></i>&nbsp;üí° Coding Hint
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <div id="hint-status" class="mb-2" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary mr-2" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <small class="text-muted" id="hint-status-text">Generating hint...</small>
                        </div>
                    </div>
                    <div id="hint-content">
                        <!-- Hint content will be populated here -->
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" id="stop-hint-button" class="btn btn-danger" style="display: none;">
                        <i class="bi bi-stop-circle"></i>&nbsp;Stop Hint
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i>&nbsp;Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Doubts Overview Modal -->
    <div id="doubts-overview-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1070;">
        <div class="modal-dialog modal-lg" style="max-width: 900px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-question-circle"></i>&nbsp;üí≠ Message Doubts
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <div id="doubts-overview-loading" class="text-center mb-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading doubts...</p>
                    </div>
                    <div id="doubts-overview-content">
                        <!-- Doubts will be populated here -->
                    </div>
                    <div id="doubts-overview-empty" class="text-center text-muted" style="display: none;">
                        <i class="bi bi-chat-dots" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">No doubts yet for this message.</p>
                        <button class="btn btn-primary btn-sm" id="ask-first-doubt-btn">
                            <i class="bi bi-plus-circle"></i>&nbsp;Ask First Doubt
                        </button>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" class="btn btn-success" id="ask-new-doubt-from-overview-btn">
                        <i class="bi bi-plus-circle"></i>&nbsp;Ask New Doubt
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i>&nbsp;Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Doubt Chat Modal -->
    <div id="doubt-chat-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1080;">
        <div class="modal-dialog modal-xl" style="max-width: 1200px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-chat-dots"></i>&nbsp;üí¨ Doubt Conversation
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div id="doubt-chat-container" style="height: 80vh; display: flex; flex-direction: column;">
                        <div id="doubt-chat-messages" style="flex: 1; overflow-y: auto; padding: 1rem; background-color: #f8f9fa;">
                            <!-- Doubt conversation messages will appear here -->
                        </div>
                        <div id="doubt-chat-input-area" style="border-top: 1px solid #ddd; padding: 1rem; background-color: white;">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="doubt-voice-record-span" style="border-right: none; background-color: transparent;">  
                                        <label for="doubt-voice-record" class="mb-0" style="cursor: pointer;">  
                                            <i class="fa fa-microphone"></i>  
                                        </label>  
                                        <button id="doubt-voice-record" style="display: none;"></button>  
                                    </span>  
                                </div>
                                <textarea id="doubt-chat-input" class="form-control" placeholder="Ask your doubt or follow-up question..." rows="3" style="resize: none; border-left: none;"></textarea>
                                <div class="input-group-append">
                                    <button id="doubt-chat-send-btn" class="btn btn-primary" type="button" style="height: 100%;">
                                        <i class="bi bi-send"></i>&nbsp;Send
                                    </button>
                                    <button id="stop-doubt-chat-button" class="btn btn-danger" type="button" style="height: 100%; display: none; margin-left: 5px;">
                                        <i class="bi bi-stop-circle"></i>&nbsp;Stop
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted mt-1 d-block">Press Ctrl+Enter to send ‚Ä¢ Press Ctrl+K for voice input</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clarifications Modal -->
    <div id="clarifications-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1082;">
        <div class="modal-dialog modal-lg" style="max-width: 900px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd; padding: 0.5rem 0.9rem;">
                    <h5 class="modal-title" style="color: #333; font-size: 1.05rem; margin-bottom: 0;">
                        <i class="fa fa-question-circle"></i>&nbsp;Clarify Your Question
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto; font-size: 0.95rem; padding: 0.9rem;">
                    <div id="clarifications-loading" class="text-center mb-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Analyzing your question...</p>
                    </div>

                    <div id="clarifications-error" class="alert alert-warning" style="display: none;">
                        <i class="fa fa-exclamation-triangle"></i>
                        <span id="clarifications-error-text"></span>
                    </div>

                    <div id="clarifications-questions" style="display: none;">
                        <p class="text-muted mb-3">Please answer these questions to help clarify your intent (you can select multiple options if needed):</p>
                        <div id="clarifications-questions-list">
                            <!-- MCQ questions will be dynamically rendered here -->
                        </div>
                    </div>

                    <div id="clarifications-not-needed" class="text-center text-muted" style="display: none;">
                        <i class="fa fa-check-circle" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">Your question is already clear.</p>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd; padding: 0.5rem 0.9rem;">
                    <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">
                        <i class="fa fa-times"></i>&nbsp;Cancel
                    </button>
                    <button type="button" id="clarifications-apply-btn" class="btn btn-primary btn-sm" style="display: none;">
                        <i class="fa fa-check"></i>&nbsp;Apply
                    </button>
                    <button type="button" id="clarifications-apply-send-btn" class="btn btn-success btn-sm" style="display: none;">
                        <i class="fa fa-paper-plane"></i>&nbsp;Apply &amp; Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LLM Context Menu -->
    <div id="llm-context-menu" class="llm-context-menu" style="display: none;">
        <ul class="list-unstyled mb-0">
            <!-- Selection-required items (hidden when no selection) -->
            <li class="context-menu-item selection-required"><a href="#" data-action="explain"><i class="bi bi-lightbulb"></i> Explain this</a></li>
            <li class="context-menu-item selection-required"><a href="#" data-action="critique"><i class="bi bi-search"></i> Critique this</a></li>
            <li class="context-menu-item selection-required"><a href="#" data-action="expand"><i class="bi bi-arrows-expand"></i> Expand this</a></li>
            <li class="context-menu-item selection-required"><a href="#" data-action="eli5"><i class="bi bi-emoji-smile"></i> ELI5</a></li>
            <li class="divider selection-required"></li>
            <!-- Always visible items -->
            <li class="context-menu-item"><a href="#" data-action="ask-doubt"><i class="bi bi-question-circle"></i> Ask a Doubt</a></li>
            <li class="context-menu-item"><a href="#" data-action="ask-doubt-ctx"><i class="bi bi-question-circle-fill"></i> Ask a Doubt [with Ctx]</a></li>
            <li class="context-menu-item"><a href="#" data-action="ask-temp"><i class="bi bi-chat-dots"></i> Ask Temporarily</a></li>
            <li class="context-menu-item"><a href="#" data-action="ask-temp-ctx"><i class="bi bi-chat-dots-fill"></i> Ask Temporarily [with Ctx]</a></li>
            <li class="context-menu-item"><a href="#" data-action="artefacts"><i class="bi bi-files"></i> Artefacts</a></li>
            <li class="divider"></li>
            <!-- Browser actions -->
            <li class="context-menu-item selection-required"><a href="#" data-action="search-google"><i class="bi bi-google"></i> Search Google</a></li>
            <li class="context-menu-item"><a href="#" data-action="lookup"><i class="bi bi-book"></i> Lookup</a></li>
            <li class="context-menu-item"><a href="#" data-action="copy-text"><i class="bi bi-clipboard"></i> Copy text</a></li>
            <li class="context-menu-item"><a href="#" data-action="copy-link"><i class="bi bi-link-45deg"></i> Copy link</a></li>
        </ul>
    </div>

    <!-- Temporary LLM Chat Modal -->
    <div id="temp-llm-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1085;">
        <div class="modal-dialog modal-xl" style="max-width: 1200px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-chat-dots"></i>&nbsp;üí¨ <span id="temp-llm-modal-title">Temporary Chat</span>
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div id="temp-llm-container" style="height: 80vh; display: flex; flex-direction: column;">
                        <!-- Context display area (shows selected text) -->
                        <div id="temp-llm-context-display" style="padding: 0.75rem 1rem; background-color: #fff3cd; border-bottom: 1px solid #ffc107; display: none;">
                            <small class="text-muted"><strong>Selected text:</strong></small>
                            <div id="temp-llm-selected-text" style="font-style: italic; max-height: 60px; overflow-y: auto; font-size: 0.9rem;"></div>
                        </div>
                        <!-- Chat messages area -->
                        <div id="temp-llm-messages" style="flex: 1; overflow-y: auto; padding: 1rem; background-color: #f8f9fa;">
                            <!-- Temporary chat messages will appear here -->
                        </div>
                        <!-- Input area -->
                        <div id="temp-llm-input-area" style="border-top: 1px solid #ddd; padding: 1rem; background-color: white;">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text" id="temp-llm-voice-record-span" style="border-right: none; background-color: transparent;">  
                                        <label for="temp-llm-voice-record" class="mb-0" style="cursor: pointer;">  
                                            <i class="fa fa-microphone"></i>  
                                        </label>  
                                        <button id="temp-llm-voice-record" style="display: none;"></button>  
                                    </span>  
                                </div>
                                <textarea id="temp-llm-input" class="form-control" placeholder="Ask a follow-up question..." rows="3" style="resize: none; border-left: none;"></textarea>
                                <div class="input-group-append">
                                    <button id="temp-llm-send-btn" class="btn btn-primary" type="button" style="height: 100%;">
                                        <i class="bi bi-send"></i>&nbsp;Send
                                    </button>
                                    <button id="stop-temp-llm-button" class="btn btn-danger" type="button" style="height: 100%; display: none; margin-left: 5px;">
                                        <i class="bi bi-stop-circle"></i>&nbsp;Stop
                                    </button>
                                </div>
                            </div>
                            <small class="text-muted mt-1 d-block">Press Ctrl+Enter to send ‚Ä¢ This conversation is temporary and won't be saved</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Management Modal -->
    <div id="prompt-management-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
        <style>
            /* Custom styles for Prompt Manager */
            #prompt-list-items .list-group-item {
                transition: all 0.2s ease;
                border-left: 3px solid transparent;
            }
            #prompt-list-items .list-group-item.active {
                border-left-color: #007bff;
            }
            #prompt-list-items .list-group-item:hover:not(.active) {
                background-color: #f8f9fa;
                border-left-color: #dee2e6;
            }
            .create-new-prompt-container {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 8px;
                margin: 20px;
            }
            .create-new-prompt-container strong {
                color: #ffd700;
            }
            #old-prompts-toggle {
                background-color: #f0f8ff;
                border-radius: 4px;
            }
            .badge-secondary {
                background-color: #6c757d;
            }
            /* Animation for create button */
            #create-new-prompt-btn {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        </style>
        <div class="modal-dialog modal-xl" style="max-width: 1200px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-chat-left-text"></i>&nbsp;üìù Prompt Manager
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <div class="row no-gutters" style="height: 70vh;">
                        <!-- Left Panel: Prompt List -->
                        <div class="col-md-4" style="border-right: 1px solid #ddd; background-color: #f8f9fa; overflow-y: auto;">
                            <div class="p-3">
                                <!-- Search Box -->
                                <div class="input-group mb-3">
                                    <input type="text" id="prompt-search-input" class="form-control" placeholder="Search prompts...">
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary" type="button" id="prompt-search-clear">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Prompt List -->
                                <div id="prompt-list-container">
                                    <div id="prompt-list-loading" class="text-center p-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading prompts...</p>
                                    </div>
                                    <div id="prompt-list-items" class="list-group" style="display: none;">
                                        <!-- Prompt items will be populated here -->
                                    </div>
                                    <div id="prompt-list-empty" class="text-center text-muted p-4" style="display: none;">
                                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                        <p class="mt-2">No prompts found</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Panel: Prompt Editor -->
                        <div class="col-md-8" style="display: flex; flex-direction: column;">
                            <!-- Editor Header -->
                            <div id="prompt-editor-header" class="p-3" style="border-bottom: 1px solid #ddd; background-color: white;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 id="prompt-editor-title" class="mb-0">Select a prompt to edit</h6>
                                        <small id="prompt-editor-subtitle" class="text-muted"></small>
                                    </div>
                                    <div id="prompt-editor-actions" style="display: none;">
                                        <button id="prompt-copy-btn" class="btn btn-sm btn-outline-secondary" title="Copy to clipboard">
                                            <i class="bi bi-clipboard"></i> Copy
                                        </button>
                                        <button id="prompt-revert-btn" class="btn btn-sm btn-outline-warning" title="Revert changes">
                                            <i class="bi bi-arrow-counterclockwise"></i> Revert
                                        </button>
                                        <button id="prompt-save-btn" class="btn btn-sm btn-success" title="Save changes">
                                            <i class="bi bi-check-circle"></i> Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Editor Content -->
                            <div id="prompt-editor-content" class="flex-grow-1 p-3" style="overflow-y: auto; background-color: #f8f9fa;">
                                <div id="prompt-editor-empty" class="text-center text-muted" style="margin-top: 20%;">
                                    <i class="bi bi-file-text" style="font-size: 4rem; opacity: 0.3;"></i>
                                    <p class="mt-3">Select a prompt from the list to view and edit</p>
                                </div>
                                
                                <div id="prompt-editor-form" style="display: none;">
                                    <!-- Prompt Name (Read-only) -->
                                    <div class="form-group">
                                        <label for="prompt-name-input"><strong>Prompt Name</strong></label>
                                        <input type="text" id="prompt-name-input" class="form-control" readonly style="background-color: #e9ecef;">
                                    </div>
                                    
                                    <!-- Prompt Content -->
                                    <div class="form-group">
                                        <label for="prompt-content-textarea"><strong>Content</strong></label>
                                        <textarea id="prompt-content-textarea" class="form-control" rows="12" style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 13px;"></textarea>
                                        <small class="form-text text-muted">
                                            <span id="prompt-char-count">0</span> characters ‚Ä¢ 
                                            <span id="prompt-line-count">0</span> lines ‚Ä¢ 
                                            <span id="prompt-word-count">0</span> words
                                        </small>
                                    </div>
                                    
                                    <!-- Metadata Section (Collapsible) -->
                                    <div class="card">
                                        <div class="card-header" style="cursor: pointer;" data-toggle="collapse" data-target="#prompt-metadata-collapse">
                                            <i class="bi bi-info-circle"></i> Metadata (Optional)
                                            <i class="bi bi-chevron-down float-right"></i>
                                        </div>
                                        <div id="prompt-metadata-collapse" class="collapse">
                                            <div class="card-body">
                                                <div class="form-group">
                                                    <label for="prompt-description-input">Description</label>
                                                    <input type="text" id="prompt-description-input" class="form-control" placeholder="Brief description of the prompt">
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="prompt-category-input">Category</label>
                                                            <input type="text" id="prompt-category-input" class="form-control" placeholder="e.g., system, user, assistant">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="form-group">
                                                            <label for="prompt-tags-input">Tags</label>
                                                            <input type="text" id="prompt-tags-input" class="form-control" placeholder="Comma-separated tags">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <small class="text-muted">Created: <span id="prompt-created-at">N/A</span></small>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <small class="text-muted">Updated: <span id="prompt-updated-at">N/A</span></small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Messages -->
                                    <div id="prompt-editor-messages" class="mt-3">
                                        <!-- Success/Error messages will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <div class="mr-auto">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Changes are saved automatically when you click Save
                        </small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Settings Modal -->
    <div id="chat-settings-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1055;">
        <div class="modal-dialog modal-xl" style="max-width: 1400px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); position: relative; z-index: 1056;">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="fa fa-cogs"></i>&nbsp;‚öôÔ∏è Chat Settings
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 88vh; overflow-y: auto;">
                    <div id="settings-content">

                        <!-- Model and Agent Selection Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-robot"></i> Model & Agent Selection</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-preamble-selector" class="form-label"><strong>Preamble Options</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-preamble-selector" multiple data-live-search="true">
                                                    <optgroup label="Default Prompts" id="default-prompts-group">
                                                        <option>No Links</option>
                                                        <option selected>Wife Prompt</option>
                                                        <!-- <option>Google GL</option> -->
                                                        <!-- <option>Google Behavioral Interview</option> -->
                                                        <option>Debug LLM</option>
                                                        <option>Short</option>
                                                        <option>Manager Assist</option>
                                                        <option>Manager Assist Short</option>
                                                        <option>Manager to Manager Framework</option>
                                                        <!-- <option>Short Coding Interview</option> -->
                                                        <option>No Code</option>
                                                        <!-- <option>ML Design Answer Short</option> -->
                                                        
                                                        <option>Argumentative</option>
                                                        <option>Blackmail</option>
                                                        <!-- <option>More Related Coding Questions</option> -->
                                                        
                                                        <option>Diagram</option>
                                                        <option>Easy Copy</option>
                                                        <option>Creative</option>
                                                        
                                                        
                                                        <option>Relationship</option>
                                                        <option>Dating Maverick</option>
                                                    </optgroup>
                                                    <optgroup label="Custom Prompts" id="custom-prompts-group">
                                                        <!-- Custom prompts will be dynamically loaded here -->
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-main-model-selector" class="form-label"><strong>Main Model</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-main-model-selector" multiple>
                                                    <optgroup label="Newer Models">
                                                        
                                                        
                                                        <option selected>openai/gpt-5.2</option>
                                                        <option hidden>openai/gpt-5.1</option>
                                                        <option>Opus 4.6</option>
                                                        <option>Opus 4.5</option>
                                                        <option>Sonnet 4.5</option>
                                                        <option>Kimi K2.5</option>                                                        
                                                        <option>google/gemini-3-pro-preview</option>                                                        
                                                        <option hidden>openai/gpt-5.2-pro</option>                                                        
                                                    </optgroup>
                                                    <optgroup label="Others">
                                                        <option>Filler</option>
                                                        <option hidden>moonshotai/kimi-k2</option>
                                                        <option>mistralai/mistral-large-2512</option>
                                                        <option>Haiku 4.5</option>
                                                        <option>google/gemini-3-flash-preview</option>
                                                        <option>deepseek-v3.1</option>
                                                        <option hidden>gpt-5.2</option>
                                                        <option hidden>gpt-5.1-codex</option>
                                                        <option hidden>Longcat Flash Chat</option>
                                                        <option hidden>gpt-5-codex</option>
                                                        <option hidden>openai/gpt-5-chat</option>
                                                        <option>qwen/qwen3-max</option>
                                                        <option hidden>x-ai/grok-4</option>
                                                        <option hidden>openai/gpt-5.1-chat</option>
                                                        <option hidden>Qwen3-Coder-Plus</option>
                                                        <option hidden>openai/chatgpt-4o-latest</option> 
                                                        <option hidden>gpt-5</option>
                                                        <option hidden>Sonnet 4</option>
                                                        <option hidden>Gemini-2.5-pro</option>
                                                        <option hidden>Opus 4.1</option>
                                                        <option>google/gemini-2.5-flash</option>
                                                        <option hidden>o4-mini-deep-research</option>
                                                        <option hidden>o3-deep-research</option>
                                                        <option hidden>x-ai/grok-3-beta</option>
                                                        <option>x-ai/grok-3</option>
                                                        <option>sao10k/l3.3-euryale-70b</option>
                                                        <option>thedrummer/anubis-pro-105b-v1</option>
                                                        <option>nousresearch/hermes-3-llama-3.1-405b</option>
                                                        <option>raifle/sorcererlm-8x22b</option>
                                                        <option>perplexity/sonar-pro</option>
                                                        <option hidden>perplexity/sonar-deep-research</option>
                                                    </optgroup>
                                                    
                                                    <optgroup hidden label="Fast Models">
                                                        <option hidden>google/gemini-2.5-flash</option>
                                                        <option hidden>google/gemini-2.5-flash-lite</option>
                                                        <option hidden>google/gemini-2.0-flash-001</option>
                                                        <option hidden>google/gemini-2.0-flash-lite-001</option>
                                                        <option hidden>qwen/qwen-turbo</option>
                                                        <option hidden>openai/gpt-4.1-mini</option>
                                                        <option hidden>x-ai/grok-3-mini</option>
                                                    </optgroup>
                                                    <optgroup hidden label="Reasoning Models">
                                                        <option hidden>Gemini-2.5-pro</option>
                                                        <option hidden>o3-pro</option>
                                                        <option hidden>minimax/minimax-m1</option>
                                                        <option hidden>o1</option>
                                                        <option hidden>o3</option>
                                                        <option hidden>o4-mini-high</option>
                                                        <option hidden>o4-mini-deep-research</option>
                                                        <option hidden>o3-deep-research</option>
                                                        <option hidden>Claude Sonnet 3.7 Thinking</option>
                                                        <option hidden>o1-pro</option>
                                                    </optgroup>
                                                    <optgroup hidden label="Creative Models">
                                                        <option hidden>sao10k/l3.3-euryale-70b</option>
                                                        <option hidden>thedrummer/anubis-pro-105b-v1</option>
                                                        <option hidden>thedrummer/anubis-70b-v1.1</option>
                                                        <option hidden>nousresearch/hermes-3-llama-3.1-405b</option>
                                                        <option hidden>raifle/sorcererlm-8x22b</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-field-selector" class="form-label"><strong>Agent</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-field-selector">
                                                    <option selected>None</option>
                                                    <option hidden>InterviewSimulator</option>
                                                    <option hidden>InterviewSimulatorV2</option>
                                                    <option>NStepCodeAgent</option>
                                                    <option hidden>CodeSolveAgent</option>
                                                    <option>InstructionFollowingAgent</option>
                                                    <option hidden>MLSystemDesignAgent</option>
                                                    <option hidden>NStepAgent</option>
                                                    <option>NResponseAgent</option>
                                                    <option>PromptWorkflowAgent</option>
                                                    <option>ManagerAssistAgent</option>
                                                    <option>PerplexitySearch</option>
                                                    <option>JinaSearchAgent</option>
                                                    <option>JinaDeepResearchAgent</option>
                                                    <option>InterleavedWebSearchAgent</option>
                                                    <option>WebSearch</option>
                                                    <option>MultiSourceSearch</option>
                                                    <option hidden>BroadSearch</option>
                                                    <option>WhatIf</option>
                                                    <option hidden>LiteratureReview</option>
                                                    <option hidden>ToCGenerationAgent</option>
                                                    <option hidden>BookCreatorAgent</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Basic Options Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-check-square"></i> Basic Options</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-perform-web-search-checkbox" type="checkbox">
                                            <label class="form-check-label" for="settings-perform-web-search-checkbox">Search</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-search-exact" type="checkbox">
                                            <label class="form-check-label" for="settings-search-exact">Search Exact</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-auto_clarify" type="checkbox">
                                            <label class="form-check-label" for="settings-auto_clarify">Auto Clarify</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-persist_or_not" type="checkbox" checked>
                                            <label class="form-check-label" for="settings-persist_or_not">Persist</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-ppt-answer" type="checkbox">
                                            <label class="form-check-label" for="settings-ppt-answer">PPT Answer</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-use_memory_pad" type="checkbox">
                                            <label class="form-check-label" for="settings-use_memory_pad">Use Memory Pad</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-enable_custom_context_menu" type="checkbox">
                                            <label class="form-check-label" for="settings-enable_custom_context_menu">LLM Right-Click Menu</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-render-slides-inline" type="checkbox" checked>
                                            <label class="form-check-label" for="settings-render-slides-inline">Render Slides Inline</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-only-slides" type="checkbox">
                                            <label class="form-check-label" for="settings-only-slides">Only Slides</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-render-close-to-source" type="checkbox">
                                            <label class="form-check-label" for="settings-render-close-to-source">Render Close</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" id="settings-use_pkb" type="checkbox" checked>
                                            <label class="form-check-label" for="settings-use_pkb">Use PKB Memory</label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mb-2" style="display:none;">
                                            <input class="form-check-input" id="settings-enable_planner" type="checkbox">
                                            <label class="form-check-label" for="settings-enable_planner">Planner</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-sliders-h"></i> Advanced Settings</h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-depthSelector" class="form-label"><strong>Depth Level</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px; display: inline-flex; align-items: center; width: 100%;">
                                                <select id="settings-depthSelector" class="form-control form-control-sm" style="width: 100%; border: none;">
                                                    <option value="1">1</option>
                                                    <option value="2" selected>2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-historySelector" class="form-label"><strong>History</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px; display: inline-flex; align-items: center; width: 100%;">
                                                <select id="settings-historySelector" class="form-control form-control-sm" style="width: 100%; border: none;">
                                                    <option value="-1">‚àÖ</option>
                                                    <option value="0">0</option>
                                                    <option value="1">1</option>
                                                    <option value="2" selected>2</option>
                                                    <option value="3">3</option>
                                                    <option value="4">4</option>
                                                    <option value="5">5</option>
                                                    <option value="6">6</option>
                                                    <option value="7">7</option>
                                                    <option value="8">8</option>
                                                    <option value="9">9</option>
                                                    <option value="10">10</option>
                                                    <option value="infinite">‚àû</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="settings-rewardLevelSelector" class="form-label"><strong>Reward Level</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px; display: inline-flex; align-items: center; width: 100%;">
                                                <select id="settings-rewardLevelSelector" class="form-control form-control-sm" style="width: 100%; border: none;">
                                                    <option value="-3">-3</option>
                                                    <option value="-2">-2</option>
                                                    <option value="-1">-1</option>
                                                    <option value="0" selected>œÜ</option>
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        

                        <!-- Actions Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-tools"></i> Actions</h6>
                                <div class="row">
                                    <div class="col">
                                        <button id="settings-deleteLastTurn" class="btn btn-danger btn-sm rounded-pill w-100">
                                            <i class="fa fa-trash"></i> Last Turn
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-info btn-sm rounded-pill w-100" id="settings-clarifyDraftButton" title="Generate clarification questions for the current draft message">
                                            <i class="fa fa-question-circle"></i> Clarify Draft
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-memory-pad-text-open-button">
                                            <i class="bi bi-pen"></i> Memory Pad
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-pkb-modal-open-button">
                                            <i class="bi bi-brain"></i> Personal Memory
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-outline-secondary btn-sm rounded-pill w-100" id="settings-user-details-modal-open-button" title="Legacy - Use Personal Memory instead">
                                            <i class="bi bi-pen"></i> User Details
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-warning btn-sm rounded-pill w-100" id="settings-clear-locks-modal-open-button" title="Check and clear stuck lock files">
                                            <i class="fa fa-lock"></i> Clear Locks
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-artefacts-modal-open-button">
                                            <i class="bi bi-files"></i> Artefacts
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-code-editor-modal-open-button">  
                                            <i class="bi bi-code-slash"></i> Code Editor  
                                        </button>  
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-primary btn-sm rounded-pill w-100" id="settings-prompt-manager-modal-open-button">
                                            <i class="bi bi-pencil-square"></i> Prompts
                                        </button>
                                    </div>
                                    <div class="col">
                                        <button class="btn btn-outline-primary btn-sm rounded-pill w-100" id="settings-model-overrides-modal-open-button">
                                            <i class="bi bi-sliders"></i> Model Overrides
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Permanent Instructions Section -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-sticky-note"></i> Permanent Instructions</h6>
                                <div class="form-group">
                                    <textarea id="settings-permanentText" class="form-control" rows="2" placeholder="Enter permanent instructions that will be included with every message..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Code Theme Section -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-code"></i> Code Theme</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="settings-code-theme-selector" class="form-label"><strong>Highlight.js Theme</strong></label>
                                            <div style="border: 1px solid #ccc; padding: 8px; border-radius: 12px;">
                                                <select class="form-control" id="settings-code-theme-selector">
                                                    <option value="default">Default</option>
                                                    <option value="github">GitHub</option>
                                                    <option value="github-dark">GitHub Dark</option>
                                                    <option value="monokai">Monokai</option>
                                                    <option value="monokai-sublime">Monokai Sublime</option>
                                                    <option value="dracula">Dracula</option>
                                                    <option value="atom-one-dark">Atom One Dark</option>
                                                    <option value="atom-one-light">Atom One Light</option>
                                                    <option value="vs">Visual Studio</option>
                                                    <option value="vs2015">VS 2015 (Dark)</option>
                                                    <option value="nord">Nord</option>
                                                    <option value="tokyo-night-dark">Tokyo Night Dark</option>
                                                    <option value="tokyo-night-light">Tokyo Night Light</option>
                                                    <option value="solarized-dark">Solarized Dark</option>
                                                    <option value="solarized-light">Solarized Light</option>
                                                    <option value="hybrid">Hybrid</option>
                                                    <option value="tomorrow-night">Tomorrow Night</option>
                                                    <option value="tomorrow-night-bright">Tomorrow Night Bright</option>
                                                    <option value="obsidian">Obsidian</option>
                                                    <option value="agate">Agate</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label"><strong>Preview</strong></label>
                                            <div class="code-theme-preview" style="border: 1px solid #ccc; border-radius: 6px; overflow: hidden;">
                                                <pre style="margin:0;"><code class="hljs javascript">// Code theme preview
function greet(name) {
    return `Hello, ${name}!`;
}
greet("World");</code></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Links Section -->
                        <div class="row mb-3" style="display: none;">
                            <div class="col-12">
                                <h6 class="text-primary mb-3"><i class="fa fa-search"></i> Search & Links</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="settings-linkInput" class="form-label"><strong>Links to Visit</strong></label>
                                            <textarea id="settings-linkInput" class="form-control" rows="3" placeholder="Links to visit, each in a new line"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="settings-searchInput" class="form-label"><strong>Search Phrases</strong></label>
                                            <textarea id="settings-searchInput" class="form-control" rows="3" placeholder="Search phrases, each in a new line"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Extension: Workflows Section -->
                                <div id="settings-workflows-section" class="row mb-4" style="display: none;">
                                    <div class="col-12">
                                        <h6 class="text-primary mb-3"><i class="fa fa-list-ol"></i> Workflows</h6>
                                        <div id="workflow-list"></div>
                                        <button class="btn btn-sm btn-primary mt-2" id="workflow-create-btn"><i class="fa fa-plus"></i> New Workflow</button>
                                    </div>
                                </div>

                                <!-- Extension: Scripts Section -->
                                <div id="settings-scripts-section" class="row mb-4" style="display: none;">
                                    <div class="col-12">
                                        <h6 class="text-primary mb-3"><i class="fa fa-code"></i> Custom Scripts</h6>
                                        <div id="script-list"></div>
                                        <button class="btn btn-sm btn-primary mt-2" id="script-create-btn"><i class="fa fa-plus"></i> New Script</button>
                                        <button class="btn btn-sm btn-outline-secondary mt-2 ml-1" id="script-generate-btn"><i class="fa fa-magic"></i> Generate with LLM</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" id="settings-reset-button" class="btn btn-warning">
                        <i class="fa fa-undo"></i> Reset to Defaults
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fa fa-times"></i> Close
                    </button>
                    <small class="text-muted mr-auto">Settings are automatically applied when you close this dialog</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Picker Modal -->
    <div id="tab-picker-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1070;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fa fa-clone"></i> Multi-Tab Capture</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="tab-picker-selected-count" class="text-muted small">0 selected</span>
                        <div>
                            <button id="tab-picker-select-all" class="btn btn-sm btn-outline-secondary">Select All</button>
                            <button id="tab-picker-deselect-all" class="btn btn-sm btn-outline-secondary">Deselect All</button>
                        </div>
                    </div>
                    <div id="tab-picker-list" style="max-height: 400px; overflow-y: auto;"></div>
                    <div id="tab-picker-progress" style="display: none;" class="mt-3">
                        <div class="progress">
                            <div id="tab-picker-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <small id="tab-picker-progress-text" class="text-muted"></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="tab-picker-cancel-btn" class="btn btn-warning" style="display: none;">Cancel</button>
                    <button id="tab-picker-capture-btn" class="btn btn-primary" disabled>Capture Selected</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Viewer Modal (for extracted page content) -->
    <div id="content-viewer-modal" class="d-none" style="position:fixed;top:0;left:0;right:0;bottom:0;z-index:1080;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;">
        <div class="cv-modal-content" style="background:#fff;border-radius:8px;width:90%;max-width:900px;max-height:85vh;display:flex;flex-direction:column;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
            <div class="cv-modal-header d-flex justify-content-between align-items-center" style="padding:12px 16px;border-bottom:1px solid #dee2e6;">
                <h5 id="cv-title" class="mb-0" style="font-size:1rem;">Extracted Content</h5>
                <button id="cv-close" type="button" class="close" style="font-size:1.2rem;">&times;</button>
            </div>
            <div id="cv-pagination" class="d-flex align-items-center justify-content-center" style="padding:6px 16px;gap:8px;border-bottom:1px solid #dee2e6;background:#f8f9fa;">
                <button id="cv-prev-page" class="btn btn-sm btn-outline-secondary" disabled>&laquo; Prev</button>
                <span id="cv-page-indicator" style="font-size:12px;color:#6c757d;min-width:80px;text-align:center;">Page 1 / 1</span>
                <span id="cv-edited-indicator" class="d-none" style="font-size:11px;color:#e67e22;font-weight:600;">(edited)</span>
                <button id="cv-next-page" class="btn btn-sm btn-outline-secondary" disabled>Next &raquo;</button>
                <button id="cv-show-all" class="btn btn-sm btn-outline-info">All</button>
            </div>
            <div style="flex:1;overflow-y:auto;padding:12px 16px;">
                <textarea id="cv-text" style="font-family:'SF Mono','Fira Code','Cascadia Code',monospace;font-size:12px;line-height:1.6;white-space:pre-wrap;word-break:break-word;background:#f8f9fa;border:1px solid #dee2e6;border-radius:4px;padding:12px;margin:0;max-height:55vh;overflow-y:auto;resize:vertical;width:100%;"></textarea>
            </div>
            <div class="cv-modal-footer d-flex align-items-center" style="padding:8px 16px;border-top:1px solid #dee2e6;">
                <span id="cv-char-count" style="font-size:11px;color:#6c757d;margin-right:auto;"></span>
                <button id="cv-reset-page" class="btn btn-sm btn-outline-warning mr-2 d-none">Reset Page</button>
                <button id="cv-copy-page" class="btn btn-sm btn-outline-secondary mr-2">Copy Page</button>
                <button id="cv-copy-all" class="btn btn-sm btn-primary">Copy All</button>
            </div>
        </div>
    </div>

    <!-- Conversation Model Overrides Modal -->
    <div id="model-overrides-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1065;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-sliders"></i> Conversation Model Overrides</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        These overrides apply to the active conversation only. Leave empty to use defaults.
                    </p>
                    <div class="form-group">
                        <label for="settings-summary-model" class="form-label"><strong>Summary Model</strong></label>
                        <select class="form-control" id="settings-summary-model"></select>
                        <small class="form-text text-muted">Used when updating the running summary and conversation title.</small>
                    </div>
                    <div class="form-group">
                        <label for="settings-tldr-model" class="form-label"><strong>TLDR Model</strong></label>
                        <select class="form-control" id="settings-tldr-model"></select>
                        <small class="form-text text-muted">Used to generate the TLDR section for long answers.</small>
                    </div>
                    <div class="form-group">
                        <label for="settings-artefact-propose-model" class="form-label"><strong>Artefact Propose Edits Model</strong></label>
                        <select class="form-control" id="settings-artefact-propose-model"></select>
                        <small class="form-text text-muted">Used when proposing edits inside the artefacts modal.</small>
                    </div>
                    <div class="form-group">
                        <label for="settings-doubt-clearing-model" class="form-label"><strong>Doubt Clearing Model</strong></label>
                        <select class="form-control" id="settings-doubt-clearing-model"></select>
                        <small class="form-text text-muted">Used when answering doubts about a specific message.</small>
                    </div>
                    <div class="form-group">
                        <label for="settings-context-action-model" class="form-label"><strong>Context Menu Action Model</strong></label>
                        <select class="form-control" id="settings-context-action-model"></select>
                        <small class="form-text text-muted">Used for explain/critique/expand/ELI5 actions.</small>
                    </div>
                    <hr>
                    <h6 class="text-primary mb-3"><i class="bi bi-journal-text"></i> Doc Index Models</h6>
                    <div class="form-group">
                        <label for="settings-doc-long-summary-model" class="form-label"><strong>Doc Long Summary Model</strong></label>
                        <select class="form-control" id="settings-doc-long-summary-model"></select>
                        <small class="form-text text-muted">Used for long document summaries and chain-of-density steps.</small>
                    </div>
                    <div class="form-group">
                        <label for="settings-doc-long-summary-v2-model" class="form-label"><strong>Doc Long Summary V2 Model</strong></label>
                        <select class="form-control" id="settings-doc-long-summary-v2-model"></select>
                        <small class="form-text text-muted">Used for multi-facet document summaries.</small>
                    </div>
                    <div class="form-group">
                        <label for="settings-doc-short-answer-model" class="form-label"><strong>Doc Short Answer Model</strong></label>
                        <select class="form-control" id="settings-doc-short-answer-model"></select>
                        <small class="form-text text-muted">Used for document Q&A and contextual readers.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="settings-model-overrides-save-button">Save Overrides</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Z-Index CSS Fix -->
    <style>
        /* Chat Settings Modal - Base level */
        #chat-settings-modal.modal {
            z-index: 1055 !important;
        }
        #chat-settings-modal .modal-backdrop {
            z-index: 1054 !important;
        }
        #chat-settings-modal .modal-dialog {
            z-index: 1056 !important;
            position: relative;
        }
        #chat-settings-modal .modal-content {
            z-index: 1057 !important;
            position: relative;
        }

        /* ‚îÄ‚îÄ Compact Chat Settings Modal ‚îÄ‚îÄ */
        #chat-settings-modal .modal-header {
            padding: 0.35rem 0.75rem;
        }
        #chat-settings-modal .modal-title {
            font-size: 0.95rem;
        }
        #chat-settings-modal .modal-body {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.82rem;
        }
        #chat-settings-modal .modal-footer {
            padding: 0.3rem 0.75rem;
        }
        #chat-settings-modal .modal-footer .btn {
            font-size: 0.78rem;
            padding: 0.2rem 0.6rem;
        }
        #chat-settings-modal .modal-footer small {
            font-size: 0.72rem;
        }
        /* Section headings */
        #chat-settings-modal #settings-content h6 {
            font-size: 0.82rem;
            margin-bottom: 0.25rem !important;
        }
        /* Reduce section row margins */
        #chat-settings-modal #settings-content > .row.mb-4 {
            margin-bottom: 0.5rem !important;
        }
        #chat-settings-modal #settings-content > .row.mb-3 {
            margin-bottom: 0.35rem !important;
        }
        /* Labels */
        #chat-settings-modal label,
        #chat-settings-modal .form-label {
            font-size: 0.78rem;
            margin-bottom: 0.1rem;
        }
        #chat-settings-modal label strong {
            font-weight: 600;
        }
        /* Form controls */
        #chat-settings-modal .form-control {
            font-size: 0.78rem;
            padding: 0.15rem 0.35rem;
            height: auto;
            min-height: unset;
        }
        #chat-settings-modal select.form-control {
            padding: 0.1rem 0.25rem;
            height: auto;
        }
        #chat-settings-modal .form-control-sm {
            font-size: 0.76rem;
            padding: 0.1rem 0.25rem;
        }
        #chat-settings-modal .form-group {
            margin-bottom: 0.3rem;
        }
        /* Checkbox rows */
        #chat-settings-modal .form-check {
            margin-bottom: 0.05rem !important;
            padding-top: 0;
            padding-bottom: 0;
            min-height: auto;
        }
        #chat-settings-modal .form-check-label {
            font-size: 0.78rem;
            line-height: 1.3;
        }
        /* Bordered selector wrappers */
        #chat-settings-modal div[style*="border: 1px solid #ccc; padding: 8px"] {
            padding: 3px !important;
            border-radius: 8px !important;
        }
        #chat-settings-modal div[style*="border: 1px solid #ccc; padding: 8px; border-radius: 12px; display: inline-flex"] {
            padding: 2px 3px !important;
        }
        /* Action buttons */
        #chat-settings-modal .btn-sm {
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            line-height: 1.4;
        }
        /* Textarea for permanent instructions */
        #chat-settings-modal textarea.form-control {
            font-size: 0.78rem;
            line-height: 1.35;
        }
        /* Code theme preview - smaller */
        #chat-settings-modal .code-theme-preview pre {
            margin-bottom: 0;
        }
        #chat-settings-modal .code-theme-preview pre code {
            font-size: 0.7rem;
            line-height: 1.25;
            padding: 0.4rem;
        }
        /* Column gutters tighter */
        #chat-settings-modal .col,
        #chat-settings-modal [class*="col-md-"] {
            padding-left: 6px;
            padding-right: 6px;
        }
        /* Inner row spacing */
        #chat-settings-modal .row {
            margin-left: -6px;
            margin-right: -6px;
        }

        /* Secondary Modals - Higher level to appear above chat settings */
        #memory-pad-modal.modal,
        #user-details-modal.modal,
        #user-preferences-modal.modal,
        #code-editor-modal.modal,
        #artefacts-modal.modal,
        #model-overrides-modal.modal {
            z-index: 1065 !important;
        }
        
        #memory-pad-modal .modal-backdrop,
        #user-details-modal .modal-backdrop,
        #user-preferences-modal .modal-backdrop,
        #code-editor-modal .modal-backdrop,
        #artefacts-modal .modal-backdrop,
        #model-overrides-modal .modal-backdrop {
            z-index: 1064 !important;
        }

        #memory-pad-modal .modal-dialog,
        #user-details-modal .modal-dialog,
        #user-preferences-modal .modal-dialog,
        #code-editor-modal .modal-dialog,
        #artefacts-modal .modal-dialog,
        #model-overrides-modal .modal-dialog {
            z-index: 1066 !important;
            position: relative;
        }

        #memory-pad-modal .modal-content,
        #user-details-modal .modal-content,
        #user-preferences-modal .modal-content,
        #code-editor-modal .modal-content,
        #artefacts-modal .modal-content,
        #model-overrides-modal .modal-content {
            z-index: 1067 !important;
            position: relative;
        }

        #artefacts-modal .modal-dialog {
            max-width: 100%;
            width: 100%;
            height: 100%;
            margin: 0;
        }

        #artefacts-modal .modal-content {
            height: 100%;
            border-radius: 0;
        }

        #artefacts-modal .modal-body {
            padding: 0;
            height: calc(100vh - 120px);
        }
        
        /* LLM Context Menu Styles */
        .llm-context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 200px;
            padding: 8px 0;
            font-size: 0.9rem;
        }
        
        .llm-context-menu .context-menu-item a {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            text-decoration: none;
            color: #333;
            transition: background-color 0.15s ease;
        }
        
        .llm-context-menu .context-menu-item a:hover {
            background-color: #f0f7ff;
            color: #007bff;
        }
        
        .llm-context-menu .context-menu-item a i {
            margin-right: 10px;
            width: 16px;
            text-align: center;
            color: #6c757d;
        }
        
        .llm-context-menu .context-menu-item a:hover i {
            color: #007bff;
        }
        
        .llm-context-menu .divider {
            border-top: 1px solid #eee;
            margin: 6px 0;
        }
        
        .llm-context-menu .context-menu-item:first-child a {
            border-radius: 8px 8px 0 0;
        }
        
        .llm-context-menu .context-menu-item:last-child a {
            border-radius: 0 0 8px 8px;
        }
        
        /* Temporary LLM Modal Styles */
        #temp-llm-modal .temp-llm-card {
            margin-bottom: 1rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        #temp-llm-modal .temp-llm-card.user-message {
            background-color: #e3f2fd;
            margin-left: 20%;
        }
        
        #temp-llm-modal .temp-llm-card.assistant-message {
            background-color: #ffffff;
            margin-right: 5%;
        }
        
        #temp-llm-modal .temp-llm-card .card-header {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            background: transparent;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        #temp-llm-modal .temp-llm-card .card-body {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        
        /* Slide Presentation Styles */
        .slide-presentation-wrapper {
            width: 100%;
            margin: 20px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .slide-presentation-wrapper .reveal {
            width: 100%;
            height: 500px; /* Fixed height for embedded slides */
            background: #ffffff;
        }
        
        .slide-presentation-wrapper .reveal .slides {
            width: 100%;
            height: 100%;
        }
        
        .slide-presentation-wrapper .reveal .slides section {
            height: 100%;
            max-height: 450px;
            overflow: hidden;
            padding: 20px !important;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            font-size: 0.9em;
        }
        
        /* Slide content styling */
        .slide-presentation-wrapper .reveal h1,
        .slide-presentation-wrapper .reveal h2,
        .slide-presentation-wrapper .reveal h3 {
            margin-top: 0;
            margin-bottom: 0.5em;
            color: #2c3e50;
        }
        
        .slide-presentation-wrapper .reveal h2 {
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .slide-presentation-wrapper .reveal h3 {
            font-size: 1.2em;
            color: #34495e;
        }
        
        .slide-presentation-wrapper .reveal p {
            margin: 0.5em 0;
            line-height: 1.4;
        }
        
        .slide-presentation-wrapper .reveal ul,
        .slide-presentation-wrapper .reveal ol {
            margin: 0.5em 0;
        }
        
        .slide-presentation-wrapper .reveal li {
            margin: 0.2em 0;
            line-height: 1.3;
        }
        
        /* Code block styling for slides */
        .slide-presentation-wrapper .reveal pre {
            width: 100%;
            margin: 10px 0;
            box-shadow: 0px 3px 10px rgba(0, 0, 0, 0.15);
            border-radius: 5px;
            background: #f8f8f8;
            border: 1px solid #e1e1e8;
        }
        
        .slide-presentation-wrapper .reveal pre code {
            max-height: 300px;
            font-size: 0.8em;
            line-height: 1.3;
            padding: 15px;
            overflow-y: auto;
            display: block;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #f8f8f8;
        }
        
        .slide-presentation-wrapper .reveal code {
            font-size: 0.85em;
            padding: 2px 6px;
            background: #f4f4f4;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #c7254e;
            border: 1px solid #e1e1e8;
        }
        
        /* Special coding elements */
        .slide-presentation-wrapper .complexity-analysis {
            background: #ecf0f1;
            padding: 10px;
            border-radius: 4px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
        }
        
        .slide-presentation-wrapper .algorithm-step {
            background: #e8f6f3;
            padding: 8px;
            border-left: 4px solid #1abc9c;
            margin: 6px 0;
            font-size: 0.8em;
        }
        
        /* Navigation controls styling */
        .slide-controls {
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        .slide-controls .btn {
            font-size: 0.85em;
            padding: 6px 12px;
        }
        
        .slide-counter-display {
            font-weight: 500;
            color: #495057;
        }
        
        /* Responsive design for slides */
        @media (max-width: 768px) {
            .slide-presentation-wrapper .reveal {
                height: 400px;
            }
            
            .slide-presentation-wrapper .reveal .slides section {
                max-height: 350px;
                padding: 15px !important;
                font-size: 0.8em;
            }
            
            .slide-presentation-wrapper .reveal pre code {
                font-size: 0.7em;
                max-height: 200px;
            }
            
            .slide-controls {
                padding: 10px;
            }
            
            .slide-controls .btn {
                font-size: 0.8em;
                padding: 4px 8px;
            }
        }
        
        /* Hide default Reveal.js controls since we have custom ones */
        .slide-presentation-wrapper .reveal .controls {
            display: none;
        }
        
        .slide-presentation-wrapper .reveal .progress {
            height: 3px;
            color: #3498db;
        }
    </style>

    <!-- Full Solution Modal -->
    <div id="solution-modal" class="modal fade" tabindex="-1" aria-hidden="true" style="z-index: 1090;">
        <div class="modal-dialog modal-xl" style="max-width: 900px;">
            <div class="modal-content" style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                <div class="modal-header" style="border-bottom: 1px solid #ddd;">
                    <h5 class="modal-title" style="color: #333;">
                        <i class="bi bi-lightbulb-fill"></i>&nbsp;üéØ Complete Solution
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="color: #aaa; font-size: 28px; font-weight: bold; line-height: 1;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                    <div id="solution-status" class="mb-2" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm text-primary mr-2" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <small class="text-muted" id="solution-status-text">Generating solution...</small>
                        </div>
                    </div>
                    <div id="solution-content">
                        <!-- Solution content will be populated here -->
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #ddd;">
                    <button type="button" id="stop-solution-button" class="btn btn-danger" style="display: none;">
                        <i class="bi bi-stop-circle"></i>&nbsp;Stop Solution
                    </button>
                    <button type="button" id="copy-solution-btn" class="btn btn-primary" style="margin-right: 8px;">
                        <i class="bi bi-clipboard"></i>&nbsp;Copy to Editor
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="bi bi-x-circle"></i>&nbsp;Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Editor Modal -->  
    <div class="modal fade" id="code-editor-modal" tabindex="-1" aria-hidden="true" style="z-index: 1075;">
      <div class="modal-dialog modal-xl"> <!-- Using modal-xl for more space -->  
        <div class="modal-content">  
          <div class="modal-header">  
            <h5 class="modal-title">  
              <i class="bi bi-code-slash"></i>&nbsp;Python Code Editor  
            </h5>  
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">  
              <span aria-hidden="true">&times;</span>  
            </button>  
          </div>  
          <div class="modal-body p-0"> <!-- Remove padding for full editor space -->  
            <!-- Toolbar for copy/paste actions -->  
            <div class="border-bottom p-2 bg-light">  
              <div class="btn-group" role="group">  
                <button type="button" id="copy-code-button" class="btn btn-sm btn-outline-primary">  
                  <i class="bi bi-clipboard"></i>&nbsp;Copy Code  
                </button> 
              </div>
              <div class="btn-group" role="group">  

                <button type="button" id="hint-code-button" class="btn btn-sm btn-outline-info">  
                  <i class="bi bi-lightbulb-fill"></i></i>&nbsp;Hint  
                </button> 
              </div>
              <div class="btn-group" role="group">  
                <button type="button" id="full-solution-code-button" class="btn btn-sm btn-outline-warning">  
                  <i class="bi bi-magic"></i></i>&nbsp;<b>Full Solution</b>  
                </button> 
              </div>
              <div class="btn-group" role="group">  
                 
                <button type="button" id="clear-code-button" class="btn btn-sm btn-outline-danger">  
                  <i class="bi bi-trash"></i>&nbsp;Clear  
                </button>  
              </div>  
              <div class="btn-group float-right" role="group">  
                <button type="button" id="format-code-button" class="btn btn-sm btn-outline-info">  
                  <i class="bi bi-magic"></i>&nbsp;Format  
                </button>  
              </div>  
            </div>  
            <!-- CodeMirror Editor Container -->  
          <div id="python-code-editor" style="height: calc(80vh - 120px); border: none;"></div>  
          </div>  
          <div class="modal-footer">  
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>  
            <button type="button" id="save-code-button" class="btn btn-primary" hidden>  
              <i class="bi bi-check-lg"></i>&nbsp;Save Code  
            </button>  

            <button type="button" id="run-code-button" class="btn btn-success">  
              <i class="bi bi-play-fill"></i>&nbsp;Run Code  
            </button>  
          </div>  
        </div>  
      </div>  
    </div>  


    <!-- Code Execution Results Modal -->  
    <!-- Code Execution Results Modal - Scrollable Version -->  
    <div class="modal fade" id="code-results-modal" tabindex="-1" aria-hidden="true" style="z-index: 1076;">  
      <div class="modal-dialog modal-lg" style="max-width: 90vw; height: 80vh; margin: 10vh auto;">  
        <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">  
          <div class="modal-header" style="flex-shrink: 0;">  
            <h5 class="modal-title">  
              <i class="bi bi-terminal"></i>&nbsp;Code Execution Results  
            </h5>  
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">  
              <span aria-hidden="true">&times;</span>  
            </button>  
          </div>  
            
          <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 1rem;">  
            <!-- Loading state -->  
            <div id="results-loading" class="text-center py-4">  
              <div class="spinner-border text-primary" role="status">  
                <span class="sr-only">Executing code...</span>  
              </div>  
              <p class="mt-2 text-muted">Executing your Python code...</p>  
            </div>  
      
            <!-- Results content (hidden initially) - This div will scroll -->  
            <div id="results-content" class="d-none" style="max-height: none; word-wrap: break-word; white-space: pre-wrap;">  
              <!-- This div will contain the markdown-rendered results -->  
            </div>  
      
            <!-- Error state (hidden initially) -->  
            <div id="results-error" class="d-none">  
              <div class="alert alert-danger">  
                <h6><i class="bi bi-exclamation-triangle"></i> Execution Error</h6>  
                <pre id="error-details" class="mb-0" style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;"></pre>  
              </div>  
            </div>  
          </div>  
            
          <div class="modal-footer" style="flex-shrink: 0;">  
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>  
            <button type="button" id="copy-results-button" class="btn btn-outline-primary">  
              <i class="bi bi-clipboard"></i>&nbsp;Copy Results  
            </button>  
          </div>  
        </div>  
      </div>  
    </div>  






    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
    <script src="interface/parseMessageForCheckBoxes.js"></script>
    <script src="interface/common.js"></script>
    <script src="interface/rendered-state-manager.js"></script>
    <script src="interface/gamification.js"></script>
    <script src="interface/common-chat.js"></script>
    <script src="interface/markdown-editor.js"></script>
    <script src="interface/interface.js"></script>
    <script src="interface/codemirror.js"></script>
    <script src="interface/doubt-manager.js"></script>
    <script src="interface/clarifications-manager.js"></script>
    <script src="interface/temp-llm-manager.js"></script>
    <script src="interface/context-menu-manager.js"></script>
    <script src="interface/prompt-manager.js"></script>
    <script src="interface/pkb-manager.js"></script>
    <script src="interface/artefacts-manager.js"></script>
    <script src="interface/global-docs-manager.js"></script>
    <script src="interface/chat.js"></script>
    <!-- Add to the <head> section -->
    <link rel="stylesheet" href="interface/workspace-styles.css">

    <!-- jsTree for sidebar file-tree display -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.17/themes/default-dark/style.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.17/jstree.min.js"></script>

    <!-- Add before closing </body> tag -->
    <script src="interface/workspace-manager.js"></script>

    <script src="interface/audio_process.js"></script>

    <!-- Extension Bridge Integration -->
    <script src="interface/extension-bridge.js"></script>
    <script src="interface/page-context-manager.js"></script>
    <script src="interface/content-viewer.js"></script>
    <script src="interface/tab-picker-manager.js"></script>
    <script src="interface/workflow-manager.js"></script>
    <script src="interface/script-manager.js"></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true,
          skipTags: ["code", "pre", "math", "script"],
        },
        
        extensions: ["tex2jax.js", "MathMenu.js", "MathZoom.js", "AssistiveMML.js"],
        TeX: {
          extensions: ["AMSmath.js", "AMSsymbols.js", "noErrors.js", "noUndefined.js", "color.js", "cases.js"],
          Macros: {
            
            RR: "\\mathbb{R}",
            bold: ["\\mathbf{#1}", 1],
            red: ["\\color{red}{#1}", 1]
          }
        },
        "HTML-CSS": { 
          linebreaks: { automatic: true, width: "container" }
      }
      });
  </script>
  <style>
    .details-close-btn {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 10px;
        display: inline-block;
    }
    .details-close-btn:hover {
        background-color: #e0e0e0;
    }

    /* Custom styling for hint and solution modals */
    #hint-modal, #solution-modal {
        z-index: 1090 !important; /* Above code editor modal */
    }

    /* Code Editor Modal - Mid level */
    #code-editor-modal.modal {
        z-index: 1075 !important;
    }
    #hint-modal .modal-content, #solution-modal .modal-content {
        border: none;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    #hint-modal .modal-header, #solution-modal .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
    }
    
    #hint-modal .modal-title, #solution-modal .modal-title {
        color: white !important;
        font-weight: 600;
    }
    
    #hint-modal .close, #solution-modal .close {
        color: white !important;
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    
    #hint-modal .close:hover, #solution-modal .close:hover {
        opacity: 1;
        color: white !important;
    }
    
    #hint-content, #solution-content {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
    }
    
    #hint-content pre, #solution-content pre {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        overflow-x: auto;
    }
    
    #hint-content code, #solution-content code {
        background-color: #f8f9fa;
        color: #e83e8c;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 0.9em;
    }
    
    #copy-solution-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        transition: all 0.2s;
    }
    
    #copy-solution-btn:hover {
        background: linear-gradient(135deg, #218838 0%, #1da589 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* Doubt Management Styling */
    .show-doubts-button, .ask-doubt-button {
        color: #6c757d;
        transition: color 0.2s;
    }
    
    .show-doubts-button:hover {
        color: #007bff !important;
    }
    
    .ask-doubt-button:hover {
        color: #28a745 !important;
    }
    
    #doubts-overview-modal, #doubt-chat-modal {
        z-index: 1070 !important;
    }
    
    .doubt-preview-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .doubt-preview-card:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.15);
        transform: translateY(-1px);
    }
    
    .doubt-preview-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-size: 0.9rem;
        padding: 0.1rem 1rem;
    }
    
    .doubt-preview-card .card-body {
        padding: 1rem;
        font-size: 0.9rem;
    }
    
    .doubt-conversation-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        max-width: 85%;
    }
    
    .doubt-conversation-card.user-doubt {
        margin-left: auto;
        background-color: #e3f2fd;
        border-color: #2196f3;
    }
    
    .doubt-conversation-card.assistant-doubt {
        margin-right: auto;
        background-color: #f1f8e9;
        border-color: #4caf50;
    }
    
    .doubt-conversation-card .card-header {
        font-size: 0.8rem;
        padding: 0.1rem 0.8rem;
        font-weight: 600;
    }
    
    .doubt-conversation-card.user-doubt .card-header {
        background-color: #2196f3;
        color: white;
        border-bottom: 1px solid #1976d2;
    }
    
    .doubt-conversation-card.assistant-doubt .card-header {
        background-color: #4caf50;
        color: white;
        border-bottom: 1px solid #388e3c;
    }
    
    .doubt-conversation-card .card-body {
        padding: 0.8rem;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    #doubt-chat-input {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        transition: border-color 0.2s;
    }
    
    #doubt-chat-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    #doubt-chat-send-btn {
        border-radius: 0 8px 8px 0;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        transition: all 0.2s;
    }
    
    #doubt-chat-send-btn:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .doubt-delete-btn {
        color: #dc3545;
        background: none;
        border: none;
        padding: 2px 4px;
        font-size: 0.8rem;
        opacity: 0.7;
        transition: all 0.2s;
    }
    
    .doubt-delete-btn:hover:not(:disabled) {
        opacity: 1;
        color: #c82333;
        background-color: rgba(220,53,69,0.1);
        border-radius: 3px;
    }
    
    .doubt-delete-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        color: #6c757d !important;
    }
    
    /* Message card header styling */
    .card-header .dropdown-toggle-no-caret::after {
        display: none;
    }
    
    .card-header .dropdown-toggle-no-caret {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 1rem;
        padding: 2px 4px;
    }
    
    .card-header .dropdown-toggle-no-caret:hover {
        color: #495057;
        background-color: rgba(0,0,0,0.05);
        border-radius: 3px;
    }
    
    .card-header .dropdown-toggle-no-caret:focus {
        box-shadow: none;
        outline: none;
    }
    
    /* Copy button in header styling */
    .card-header .copy-btn-header {
        background: none;
        border: none;
        color: #6c757d;
        font-size: 1rem;
        padding: 2px 4px;
        margin-right: 5px;
    }
    
    .card-header .copy-btn-header:hover {
        color: #495057;
        background-color: rgba(0,0,0,0.05);
        border-radius: 3px;
    }
    
    .card-header .copy-btn-header:focus {
        box-shadow: none;
        outline: none;
    }
    
    /* Dropdown menu styling */
    .dropdown-menu {
        border: 1px solid #dee2e6;
        border-radius: 6px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        font-size: 0.875rem;
        z-index: 1050;
    }
    
    .dropdown-item {
        padding: 0.5rem 1rem;
        display: flex;
        align-items: center;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    .dropdown-item.text-danger:hover {
        background-color: #f5c6cb;
        color: #721c24;
    }
    
    /* Audio player container styling */
    .audio-player-container {
        margin-left: 10px;
    }
    
    .audio-player-container .audio-container {
        background: rgba(0,0,0,0.05);
        padding: 5px;
        border-radius: 5px;
        margin: 2px 0;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-header {
            padding: 0.1rem;
        }
        
        .dropdown-menu {
            font-size: 0.8rem;
        }
        
        .dropdown-item {
            padding: 0.4rem 0.8rem;
        }
        
        .audio-player-container .audio-container audio {
            max-width: 200px;
        }
        
        /* Global inline code styling for proper text wrapping and appearance */
        code.inline-code,
        code:not(.hljs):not([class*="language-"]):not([class*="hljs"]) {
            background-color: #f8f9fa !important;
            color: #e83e8c !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            font-size: 0.9em !important;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;
            word-wrap: break-word !important;
            white-space: pre-wrap !important;
            display: inline !important;
            border: 1px solid #e1e1e8 !important;
        }
        
        /* Ensure inline code doesn't break layout in paragraphs */
        p code.inline-code,
        p code:not(.hljs):not([class*="language-"]):not([class*="hljs"]) {
            line-height: 1.4 !important;
            vertical-align: baseline !important;
        }
        
        /* Prevent highlight.js from interfering with inline code */
        code.inline-code * {
            color: inherit !important;
            background: transparent !important;
        }
    }
    .h1, .h2, .h3, .h4, .h5, .h6, h1, h2, h3, h4, h5, h6 {
        margin-bottom: 0.1rem;
        font-weight: 500;
        line-height: 1.1;
    }
    .h1, h1 {
        font-size: 2rem;
    }
    .h2, h2 {
        font-size: 1.35rem;
    }
    .h3, h3 {
        font-size: 1.2rem;
    }
    .h4, h4 {
        font-size: 1rem;
    }
    .h5, h5 {
        font-size: 0.875rem;
    }
    .h6, h6 {
        font-size: 0.75rem;
    }
    p {
        margin-top: 0;
        margin-bottom: 0.5rem;
    }
    </style>
    <script>
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('details-close-btn')) {
            // Find the parent details element
            let detailsId = event.target.getAttribute('data-details-id');
            let details = detailsId ? document.getElementById(detailsId) : event.target.closest('details');
            
            if (details) {
                // Close the details element
                details.removeAttribute('open');
                // Scroll to the summary
                details.querySelector('summary').scrollIntoView({behavior: 'smooth'});
            }
        }
    });
    </script>
    
    <script>
    // Code Theme Switching Functionality
    $(document).ready(function() {
        // Initialize theme from localStorage
        var savedTheme = localStorage.getItem('highlightTheme') || 'default';
        $('#settings-code-theme-selector').val(savedTheme);
        applyHighlightTheme(savedTheme);
        
        // Handle theme change
        $('#settings-code-theme-selector').on('change', function() {
            var selectedTheme = $(this).val();
            applyHighlightTheme(selectedTheme);
            localStorage.setItem('highlightTheme', selectedTheme);
            
            // Update preview in the settings modal
            updatePreviewHighlight();
            
            // Re-highlight all existing code blocks
            reHighlightAllCode();
        });
        
        // Function to apply highlight.js theme
        function applyHighlightTheme(theme) {
            var themeLink = document.getElementById('highlight-theme');
            if (themeLink) {
                themeLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/' + theme + '.min.css';
            }
        }
        
        // Function to update preview in settings modal
        function updatePreviewHighlight() {
            $('.code-theme-preview pre code').each(function() {
                // Remove existing highlighting classes
                $(this).removeClass();
                $(this).addClass('hljs javascript');
                
                // Re-apply highlighting
                if (typeof hljs !== 'undefined') {
                    hljs.highlightElement(this);
                }
            });
        }
        
        // Function to re-highlight all code blocks in the chat
        function reHighlightAllCode() {
            // Find all code blocks in messages
            $('#messages-container pre code, .message-card pre code').each(function() {
                var element = this;
                var language = $(element).attr('class');
                
                // Skip if it's inline code
                if ($(element).hasClass('inline-code')) {
                    return;
                }
                
                // Extract language from class if present
                if (language) {
                    var langMatch = language.match(/language-(\w+)|hljs\s+(\w+)/);
                    if (langMatch) {
                        var lang = langMatch[1] || langMatch[2];
                        
                        // Re-highlight with the detected language
                        if (typeof hljs !== 'undefined' && hljs.getLanguage(lang)) {
                            // Store the original code
                            var originalCode = element.textContent || element.innerText;
                            
                            // Clear and re-highlight
                            $(element).removeClass();
                            $(element).addClass('hljs ' + lang);
                            element.innerHTML = hljs.highlight(originalCode, { language: lang }).value;
                        }
                    }
                }
            });
        }
        
        // Function to load custom prompts
        function loadCustomPrompts() {
            fetch('/get_prompts', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.prompts) {
                    // data has prompts and prompts_detailed, inside prompts_detailed (which is an array of dicts), there is description, category, and other stuff
                    // zip prompts and prompts_detailed and then filter all the prompts and prompts_detailed that have category as no-empty string.
                    // Combine prompts and prompts_detailed arrays
                    const combinedPrompts = data.prompts.map((promptName, index) => {
                        const detailedInfo = data.prompts_detailed.find(p => p.name === promptName) || {};
                        return {
                            name: promptName,
                            ...detailedInfo
                        };
                    });
                    
                    // Filter prompts that have a non-empty category
                    const categorizedPrompts = combinedPrompts.filter(prompt => 
                        prompt.category.trim() === ''
                    );
                    
                    // Update data.prompts and data.prompts_detailed in place to only include categorized prompts
                    data.prompts = categorizedPrompts.map(prompt => prompt.name);
                    data.prompts_detailed = categorizedPrompts;
                    const customPromptsGroup = $('#custom-prompts-group');
                    const currentSelected = $('#settings-preamble-selector').val() || [];
                    
                    // Clear existing custom prompts
                    customPromptsGroup.empty();
                    
                    // Filter out default prompts that are already in the default group
                    const defaultPrompts = [
                        'No Links', 'Wife Prompt', 'Debug LLM', 'Short', 'Google GL', 'Google Behavioral Interview',
                        'Short Coding Interview', 'No Code', 'ML Design Answer Short',
                        'Argumentative', 'Blackmail', 'More Related Coding Questions',
                        'Diagram', 'Easy Copy', 'Creative', 'Explore',
                        'Relationship', 'Dating Maverick'
                    ];
                    
                    // Convert default prompt names to snake_case for comparison
                    const defaultPromptKeys = defaultPrompts.map(p => 
                        p.toLowerCase().replace(/ /g, '_')
                    );
                    
                    // Clear and rebuild the cache
                    window.availableCustomPrompts = [];
                    
                    // Add custom prompts that are not in the default list
                    let customPromptsAdded = 0;
                    data.prompts.forEach(promptName => {
                        // Check if this prompt is not a default one
                        if (!defaultPromptKeys.includes(promptName.toLowerCase())) {
                            // Format the prompt name for display
                            const displayName = promptName
                                .replace(/_/g, ' ')
                                .replace(/\b\w/g, l => l.toUpperCase());
                            
                            // Update cache
                            window.availableCustomPrompts.push({
                                name: promptName,
                                value: `custom:${promptName}`,
                                displayName: displayName
                            });
                            
                            // Create option element
                            const option = $('<option></option>')
                                .val(`custom:${promptName}`)  // Prefix with custom: to identify custom prompts
                                .text(displayName);
                            
                            // Check if this was previously selected
                            if (currentSelected.includes(`custom:${promptName}`)) {
                                option.prop('selected', true);
                            }
                            
                            customPromptsGroup.append(option);
                            customPromptsAdded++;
                        }
                    });
                    
                    // Try to refresh the selectpicker if it exists, otherwise just trigger change
                    try {
                        if ($.fn.selectpicker) {
                            $('#settings-preamble-selector').selectpicker('refresh');
                        }
                    } catch (e) {
                        // Selectpicker not available, trigger change event instead
                        $('#settings-preamble-selector').trigger('change');
                    }
                    
                    // If there are custom prompts, show the optgroup, otherwise hide it
                    if (customPromptsAdded === 0) {
                        customPromptsGroup.append('<option disabled>No custom prompts available</option>');
                    }
                    
                    console.log(`Loaded ${customPromptsAdded} custom prompts`);
                }
            })
            .catch(error => {
                console.error('Error loading custom prompts:', error);
                const customPromptsGroup = $('#custom-prompts-group');
                
                // Fall back to cached prompts if fetch fails
                if (window.availableCustomPrompts && window.availableCustomPrompts.length > 0) {
                    customPromptsGroup.empty();
                    const currentSelected = $('#settings-preamble-selector').val() || [];
                    
                    window.availableCustomPrompts.forEach(prompt => {
                        const option = $('<option></option>')
                            .val(prompt.value)
                            .text(prompt.displayName);
                        if (currentSelected.includes(prompt.value)) {
                            option.prop('selected', true);
                        }
                        customPromptsGroup.append(option);
                    });
                    console.log('Using cached custom prompts due to fetch error');
                } else {
                    customPromptsGroup.empty();
                    customPromptsGroup.append('<option disabled>Error loading prompts</option>');
                }
                
                // Try to refresh the selectpicker if it exists
                try {
                    if ($.fn.selectpicker) {
                        $('#settings-preamble-selector').selectpicker('refresh');
                    }
                } catch (e) {
                    // Selectpicker not available
                    $('#settings-preamble-selector').trigger('change');
                }
            });
        }
        
        // When settings modal opens, update the preview and load custom prompts
        $('#chat-settings-modal').on('shown.bs.modal', function() {
            updatePreviewHighlight();
            loadCustomPrompts();
        });
        
        // Apply saved theme on page load
        if (savedTheme !== 'default') {
            setTimeout(function() {
                reHighlightAllCode();
            }, 500);
        }

        ExtensionBridge.init();
        console.log('[MainUI] ExtensionBridge.init() returned. Registering onAvailabilityChange...');
        console.log('[MainUI] .ext-btn count at callback registration:', $('.ext-btn').length);
        ExtensionBridge.onAvailabilityChange(function(available) {
            console.log('[MainUI] >>> onAvailabilityChange FIRED:', available);
            if (available) {
                $('.ext-btn').show();
                if (window === window.top) {
                    $('#ext-extract-page').hide();
                }
                $('#settings-workflows-section').show();
                $('#settings-scripts-section').show();
                WorkflowManager.init();
                ScriptManager.init();
            } else {
                $('.ext-btn').hide();
            }
        });
        console.log('[MainUI] All extension init done. Waiting for extension detection...');
    });
    </script>
</body>
</html>
